# Wavechoï¼ˆå›å£°ï¼‰MVP æŠ€æœ¯ä¸äº§å“è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2025-11-26  
**æ–‡æ¡£çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 äº§å“ç®€ä»‹

**Wavecho**ï¼ˆä¸­æ–‡åï¼šå›å£°ï¼‰æ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æƒ…æ„Ÿå…³ç³»å¤ç›˜ä¸æ²Ÿé€šè¾…åŠ©åº”ç”¨ã€‚

**æ ¸å¿ƒä»·å€¼ä¸»å¼ **ï¼š
- å¸®åŠ©ç”¨æˆ·åœ¨äº²å¯†å…³ç³»ã€ç¤¾äº¤å…³ç³»ä¸­ï¼Œä»¥ç¬¬ä¸‰æ–¹è§†è§’å¤ç›˜å†²çªå¯¹è¯
- é€šè¿‡ AI åˆ†æå†²çªçš„æ ¸å¿ƒçŸ›ç›¾ã€æƒ…ç»ªåŠ¨å› å’ŒçœŸå®éœ€æ±‚
- æä¾›æ¸©å’Œã€å®‰å…¨ã€å¯æ‰§è¡Œçš„æ²Ÿé€šå»ºè®®ï¼Œé™ä½å…³ç³»ä¿®å¤é—¨æ§›

**äº§å“å®šä½**ï¼š
- ä¸æ˜¯å¿ƒç†å’¨è¯¢æ›¿ä»£å“ï¼Œè€Œæ˜¯æ—¥å¸¸æ²Ÿé€šçš„"å†·é™å‰‚"å’Œ"ç¿»è¯‘å®˜"
- é¢å‘æ™®é€šç”¨æˆ·çš„è½»é‡çº§æƒ…æ„Ÿå·¥å…·ï¼Œæ³¨é‡éšç§ä¸å®‰å…¨
- å¼ºè°ƒ"å›å£°"æ¦‚å¿µï¼šè®©ç”¨æˆ·å¬è§å¯¹è¯ä¸­è¢«å¿½ç•¥çš„å£°éŸ³

### 1.2 MVP èŒƒå›´ç•Œå®š

æœ¬ MVP ç‰ˆæœ¬ä¸“æ³¨äºéªŒè¯æ ¸å¿ƒä»·å€¼å‡è®¾ï¼ŒåŠŸèƒ½èŒƒå›´ä¸¥æ ¼é™å®šä¸ºï¼š

**å¿…åšåŠŸèƒ½ï¼ˆP0ï¼‰**ï¼š
1. ç®€å•çš„ç”¨æˆ·èº«ä»½è¯†åˆ«ï¼ˆé‚®ç®± + éªŒè¯ç ç™»å½•ï¼Œæˆ– UUID åŒ¿åæ¨¡å¼ï¼‰
2. çŸ›ç›¾å¤ç›˜å•æ¬¡åˆ†ææµç¨‹ï¼š
   - è¾“å…¥ï¼šèŠå¤©è®°å½•æ–‡æœ¬ + å¯é€‰èƒŒæ™¯æè¿°
   - å¤„ç†ï¼šé£é™©åˆ†çº§ â†’ LLM åˆ†æ â†’ å®‰å…¨å®¡æŸ¥
   - è¾“å‡ºï¼šç»“æ„åŒ–åˆ†æç»“æœï¼ˆæ—¶é—´çº¿ã€æƒ…ç»ªã€éœ€æ±‚ã€å»ºè®®ï¼‰
3. åˆ†æç»“æœå±•ç¤ºé¡µï¼ˆå•é¡µè¯¦æƒ…ï¼‰

**å¯é€‰åŠŸèƒ½ï¼ˆP1ï¼Œè®¾è®¡é¢„ç•™ä½†ä¸å¼ºåˆ¶å®ç°ï¼‰**ï¼š
- å†å²è®°å½•åˆ—è¡¨é¡µ
- åˆ†æè®°å½•çš„æœ¬åœ°/äº‘ç«¯æŒä¹…åŒ–

**æ˜ç¡®ä¸åšï¼ˆV1 ä¹‹åï¼‰**ï¼š
- å®æ—¶èŠå¤©åˆ†æ
- å¤šäººåä½œå¤ç›˜
- ä»˜è´¹è®¢é˜…ä½“ç³»
- ç¤¾åŒºåˆ†äº«åŠŸèƒ½

---

## 2. å…³é”®ç”¨æˆ·æ•…äº‹ & ç”¨ä¾‹

### 2.1 å…¸å‹ç”¨æˆ·ç”»åƒ

**ç”»åƒ Aï¼šå¹´è½»æƒ…ä¾£ â€”â€” å°é›¨ï¼ˆ25 å²ï¼Œäº’è”ç½‘è¿è¥ï¼‰**
- **ç—›ç‚¹**ï¼šå’Œç”·å‹å› å°äº‹äº‰åµå,æ˜çŸ¥é“åº”è¯¥ä¸»åŠ¨å’Œå¥½ï¼Œä½†ä¸çŸ¥é“æ€ä¹ˆå¼€å£ï¼Œæ‹…å¿ƒè¯´é”™è¯åŠ å‰§çŸ›ç›¾
- **ä½¿ç”¨åœºæ™¯**ï¼šåµæ¶åå†·é™æœŸï¼Œåœ¨ç‹¬å¤„æ—¶æ‰“å¼€ Wavechoï¼Œç²˜è´´èŠå¤©è®°å½•ï¼Œçœ‹çœ‹"AI æ€ä¹ˆçœ‹è¿™ä»¶äº‹"
- **æœŸæœ›**ï¼šå¾—åˆ°ä¸€ä¸ªä¸åè¢’ä»»ä½•ä¸€æ–¹çš„å®¢è§‚åˆ†æï¼Œä»¥åŠå‡ æ¡å¯ä»¥ç›´æ¥å‘é€çš„å’Œè§£æ¶ˆæ¯æ¨¡æ¿

**ç”»åƒ Bï¼šèŒåœºæ–°äºº â€”â€” é˜¿æ°ï¼ˆ23 å²ï¼Œè®¾è®¡å¸ˆï¼‰**
- **ç—›ç‚¹**ï¼šå’ŒåŒäº‹/é¢†å¯¼æ²Ÿé€šä¸ç•…ï¼Œäº‹ååæ€æ—¶é™·å…¥è‡ªæˆ‘æ€€ç–‘ï¼Œä¸ç¡®å®šæ˜¯å¯¹æ–¹çš„é—®é¢˜è¿˜æ˜¯è‡ªå·±çš„é—®é¢˜
- **ä½¿ç”¨åœºæ™¯**ï¼šä¸‹ç­åå¤ç›˜å·¥ä½œå¯¹è¯ï¼Œç†è§£å¯¹æ–¹çœŸå®æ„å›¾ï¼Œé¿å…ä¸‹æ¬¡é‡å¤å†²çª
- **æœŸæœ›**ï¼šæ˜ç¡®çŸ›ç›¾æ ¹æºï¼Œæå‡æ²Ÿé€šèƒ½åŠ›

### 2.2 æ ¸å¿ƒä½¿ç”¨åœºæ™¯

**åœºæ™¯ 1ï¼šæƒ…ä¾£åµæ¶åçš„å’Œè§£å¤ç›˜**

> **èƒŒæ™¯**ï¼šæ˜¨æ™šå› ä¸ºé¡¹é“¾æ²¡è§£å¼€çš„å°äº‹åµæ¶ï¼ŒåŒæ–¹éƒ½è§‰å¾—å§”å±ˆ  
> **ç”¨æˆ·æ“ä½œ**ï¼š
> 1. æ‰“å¼€ Wavechoï¼Œè¿›å…¥"çŸ›ç›¾å¤ç›˜"é¡µé¢
> 2. ç²˜è´´æ˜¨æ™šçš„å¾®ä¿¡èŠå¤©è®°å½•ï¼ˆçº¦ 20 æ¡æ¶ˆæ¯ï¼‰
> 3. è¡¥å……èƒŒæ™¯ï¼š"å› ä¸ºæˆ‘å‚¬å¥¹å¿«ç‚¹è§£å¼€é¡¹é“¾ï¼Œå¥¹è§‰å¾—æˆ‘ä¸è€çƒ¦"
> 4. ç‚¹å‡»"å¼€å§‹åˆ†æ"æŒ‰é’®
> 
> **ç³»ç»Ÿå“åº”**ï¼š
> - æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆé¢„è®¡ 10-30 ç§’ï¼‰
> - è¿”å›åˆ†æç»“æœé¡µï¼ŒåŒ…å«ï¼š
>   - äº‹ä»¶æ—¶é—´çº¿ï¼šå†²çªå¦‚ä½•å‡çº§
>   - æˆ‘çš„æƒ…ç»ªï¼šç„¦è™‘ â†’ ä¸è€çƒ¦ â†’ å§”å±ˆ
>   - å¯¹æ–¹æƒ…ç»ªï¼šç´§å¼  â†’ å—ä¼¤ â†’ æ„¤æ€’
>   - æ ¸å¿ƒçŸ›ç›¾ï¼šè¡¨é¢æ˜¯é¡¹é“¾ï¼Œå®é™…æ˜¯"è¢«å‚¬ä¿ƒæ—¶çš„å‹åŠ›æ„Ÿ"ä¸"å¯¹æ•ˆç‡çš„ä¸åŒé¢„æœŸ"
>   - 3 æ¡å»ºè®®æ¶ˆæ¯ï¼ˆæ¸©å’Œé“æ­‰ç‰ˆ / è§£é‡Šç‰ˆ / å¹½é»˜åŒ–è§£ç‰ˆï¼‰
> 
> **ç”¨æˆ·æ”¶ç›Š**ï¼šç†è§£äº†å¯¹æ–¹ä¸æ˜¯æ— ç†å–é—ºï¼Œè€Œæ˜¯è¢«å‚¬ä¿ƒæ—¶æ„Ÿåˆ°ä¸è¢«ç†è§£ï¼›è·å¾—äº†å’Œè§£çš„å…·ä½“è¯æœ¯

**åœºæ™¯ 2ï¼šé«˜é£é™©å¯¹è¯çš„å®‰å…¨æç¤º**

> **èƒŒæ™¯**ï¼šç”¨æˆ·ç²˜è´´äº†åŒ…å«"ä¸æƒ³æ´»äº†""æ¶ˆå¤±ç®—äº†"ç­‰æç«¯è¡¨è¿°çš„èŠå¤©è®°å½•  
> **ç³»ç»Ÿå“åº”**ï¼š
> - é£é™©åˆ†ç±»å™¨æ£€æµ‹åˆ° `riskLevel: HIGH`ï¼Œæ ‡ç­¾åŒ…å« `self_harm`
> - Orchestrator åˆ‡æ¢åˆ°"é«˜é£é™©å®‰å…¨æ¨¡å¼"
> - LLM è¿”å›çš„å»ºè®®ä¸åŒ…å«"ç«‹åˆ»é“æ­‰""ä¸»åŠ¨ç¤ºå¥½"ç­‰å¯èƒ½åŠ å‰§å¿ƒç†è´Ÿæ‹…çš„å†…å®¹
> - ç»“æœé¡µé¡¶éƒ¨æ˜¾ç¤ºæ©™/çº¢è‰²æç¤ºå¡ç‰‡ï¼š
>   - "æˆ‘ä»¬æ³¨æ„åˆ°å¯¹è¯ä¸­åŒ…å«æƒ…ç»ªå±æœºä¿¡å·ã€‚å¦‚æœæ‚¨æˆ–å¯¹æ–¹æ­£åœ¨ç»å†ä¸¥é‡çš„æƒ…ç»ªå›°æ‰°ï¼Œè¯·è€ƒè™‘ï¼š"
>   - æä¾›å¿ƒç†æ´åŠ©çƒ­çº¿ï¼ˆå¦‚ Beijing Suicide Research and Prevention Centerï¼š010-82951332ï¼‰
>   - å»ºè®®å¯»æ±‚ä¸“ä¸šå¿ƒç†å’¨è¯¢æ”¯æŒ
> - åˆ†æç»“æœèšç„¦äº"æƒ…ç»ªæ”¯æŒ"å’Œ"ä¸“ä¸šæ±‚åŠ©å¼•å¯¼"ï¼Œè€Œéè§£å†³å…·ä½“çŸ›ç›¾

**åœºæ™¯ 3ï¼šæ™®é€šæ—¥å¸¸å¯¹è¯çš„è½»é‡åˆ†æ**

> **èƒŒæ™¯**ï¼šç”¨æˆ·æƒ³å¤ç›˜å’Œæœ‹å‹å…³äºå‘¨æœ«å®‰æ’çš„è®¨è®ºï¼Œåªæ˜¯è§‰å¾—"æœ‰ç‚¹å°´å°¬"ä½†ä¸ä¸¥é‡  
> **ç³»ç»Ÿå“åº”**ï¼š
> - é£é™©åˆ†ç±»å™¨åˆ¤å®š `riskLevel: LOW`
> - ä½¿ç”¨æ ‡å‡†åˆ†ææ¨¡æ¿ï¼Œæ­£å¸¸è¿”å›æ—¶é—´çº¿ã€æƒ…ç»ªã€å»ºè®®
> - ä¸æ˜¾ç¤ºä»»ä½•é£é™©æç¤ºå¡ç‰‡
> - å»ºè®®è¯­æ°”è½»æ¾ï¼Œä¾‹å¦‚"å¯ä»¥è¯•ç€ç›´æ¥é—®å¯¹æ–¹æ—¶é—´åå¥½"

---

## 3. æ•´ä½“ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 3.1 æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢æˆ·ç«¯å±‚ (Client Layer)                    â”‚
â”‚                  React Native + Expo (iOS/Android)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ç™»å½•/æ³¨å†Œé¡µ   â”‚  â”‚  çŸ›ç›¾å¤ç›˜é¡µ   â”‚  â”‚  åˆ†æç»“æœé¡µ    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                         â”‚ HTTPS / REST API                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API ç½‘å…³å±‚ (API Gateway)                  â”‚
â”‚                      FastAPI (Python 3.11+)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  /api/auth/*        - ç”¨æˆ·è®¤è¯æ¥å£                â”‚      â”‚
â”‚  â”‚  /api/analyze-conflict  - çŸ›ç›¾åˆ†ææ¥å£ï¼ˆæ ¸å¿ƒï¼‰    â”‚      â”‚
â”‚  â”‚  /api/sessions/*    - å†å²è®°å½•æ¥å£ï¼ˆå¯é€‰ï¼‰         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                         â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¸šåŠ¡æœåŠ¡å±‚ (Service Layer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  AuthService   â”‚  â”‚  AnalysisOrchestrator â”‚            â”‚
â”‚  â”‚  ç”¨æˆ·è®¤è¯/ä¼šè¯   â”‚  â”‚  æ ¸å¿ƒåˆ†æç¼–æ’é€»è¾‘      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                           â”‚                                â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚                 â”‚                 â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚RiskClassifierâ”‚   â”‚  LLMClient  â”‚   â”‚ResponseGuardâ”‚     â”‚
â”‚  â”‚ é£é™©åˆ†ç±»å™¨    â”‚   â”‚ å¤§æ¨¡å‹è°ƒç”¨   â”‚   â”‚  å®‰å…¨å®¡æŸ¥    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®å­˜å‚¨å±‚ (Data Layer)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚           MongoDB (æ¨è) / PostgreSQL        â”‚          â”‚
â”‚  â”‚  - users          ç”¨æˆ·é›†åˆ                   â”‚          â”‚
â”‚  â”‚  - analysis_sessions  åˆ†æä¼šè¯é›†åˆ           â”‚          â”‚
â”‚  â”‚  - audit_logs     å®¡è®¡æ—¥å¿—é›†åˆï¼ˆå¯é€‰ï¼‰        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å¤–éƒ¨æœåŠ¡å±‚ (External Services)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚OpenAI / å…¶ä»–  â”‚    â”‚ é‚®ä»¶æœåŠ¡       â”‚                     â”‚
â”‚  â”‚  LLM API     â”‚    â”‚(éªŒè¯ç å‘é€)    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæ•°æ®æµï¼šçŸ›ç›¾åˆ†æå…¨æµç¨‹

**æ­¥éª¤ 1**ï¼šç”¨æˆ·åœ¨å‰ç«¯æäº¤åˆ†æè¯·æ±‚
```
POST /api/analyze-conflict
Body: {
  "conversationText": "...",
  "contextDescription": "...",
  "userId": "uuid"
}
```

**æ­¥éª¤ 2**ï¼šAPI å±‚æ¥æ”¶è¯·æ±‚ï¼Œè°ƒç”¨ `AnalysisOrchestrator.analyze()`

**æ­¥éª¤ 3**ï¼šOrchestrator ç¼–æ’ä»¥ä¸‹æµç¨‹ï¼š

1. **æ•°æ®æŒä¹…åŒ–**ï¼šå°†åŸå§‹è¾“å…¥å†™å…¥ `analysis_sessions` é›†åˆï¼ˆstatus: `processing`ï¼‰
2. **é£é™©åˆ†ç±»**ï¼šè°ƒç”¨ `RiskClassifier.classify(conversationText)` 
   - è¾“å‡ºï¼š`{ riskLevel: "LOW|MEDIUM|HIGH|CRITICAL", tags: [...] }`
3. **Prompt é€‰æ‹©**ï¼šæ ¹æ® `riskLevel` é€‰æ‹©å¯¹åº”çš„ Prompt æ¨¡æ¿
   - LOW/MEDIUM â†’ æ ‡å‡†åˆ†ææ¨¡æ¿
   - HIGH â†’ è°¨æ…æ¨¡å¼æ¨¡æ¿ï¼ˆå¼ºè°ƒæƒ…ç»ªæ”¯æŒï¼‰
   - CRITICAL â†’ é«˜é£é™©å®‰å…¨æ¨¡æ¿ï¼ˆä»…è¾“å‡ºæ±‚åŠ©å¼•å¯¼ï¼‰
4. **LLM è°ƒç”¨**ï¼š`LLMClient.generate(prompt)` 
   - è¶…æ—¶è®¾ç½®ï¼š30 ç§’
   - é‡è¯•ç­–ç•¥ï¼šæœ€å¤š 2 æ¬¡
   - è¿”å› JSON ç»“æ„åŒ–ç»“æœ
5. **å®‰å…¨å®¡æŸ¥**ï¼š`ResponseGuard.validate(llmResponse, riskLevel)`
   - æ£€æµ‹ç¦æ­¢å†…å®¹ï¼ˆæš´åŠ›ã€è‡ªæ®‹é¼“åŠ±ç­‰ï¼‰
   - å¦‚ä¸é€šè¿‡ï¼Œå°è¯•è®© LLM æ”¹å†™ï¼ˆSelf-Refineï¼‰æˆ–é™çº§è¾“å‡º
6. **ç»“æœå­˜å‚¨**ï¼šæ›´æ–° `analysis_sessions` çŠ¶æ€ä¸º `completed`ï¼Œä¿å­˜æœ€ç»ˆç»“æœ
7. **è¿”å›å‰ç«¯**ï¼šè¿”å›å®‰å…¨ç‰ˆçš„ç»“æ„åŒ–åˆ†æ JSON

**æ­¥éª¤ 4**ï¼šå‰ç«¯æ¥æ”¶ç»“æœï¼Œæ¸²æŸ“å¡ç‰‡å¼å±•ç¤ºé¡µé¢

### 3.3 æŠ€æœ¯æ ˆé€‰å‹è¯´æ˜

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | ç†ç”± |
|------|---------|------|
| **å‰ç«¯æ¡†æ¶** | React Native + Expo | è·¨å¹³å°å¼€å‘æ•ˆç‡é«˜ï¼ŒExpo æä¾›ä¸°å¯Œçš„å¼€ç®±å³ç”¨åŠŸèƒ½ï¼ˆOTA æ›´æ–°ã€æ¨é€é€šçŸ¥é¢„ç•™ï¼‰ |
| **å‰ç«¯è¯­è¨€** | TypeScript | ç±»å‹å®‰å…¨ï¼Œé™ä½è¿è¡Œæ—¶é”™è¯¯ï¼Œæå‡åä½œæ•ˆç‡ |
| **çŠ¶æ€ç®¡ç†** | React Query + Context API | React Query å¤„ç†å¼‚æ­¥æ•°æ®ç¼“å­˜ï¼ŒContext å¤„ç†å…¨å±€ä¸»é¢˜/ç”¨æˆ·çŠ¶æ€ |
| **åç«¯æ¡†æ¶** | FastAPI (Python 3.11+) | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ï¼Œ**è‡ªåŠ¨ç”Ÿæˆ Swagger æ–‡æ¡£**ï¼Œä¸ LLM ç”Ÿæ€å…¼å®¹æ€§å¥½ |
| **Python åŒ…ç®¡ç†** | **uv** âš¡ | æé€Ÿä¾èµ–å®‰è£…ï¼ˆæ¯” pip å¿« 10-100 å€ï¼‰ã€ç°ä»£åŒ–å·¥ä½œæµã€å…¼å®¹ pip ç”Ÿæ€ã€æ”¯æŒè™šæ‹Ÿç¯å¢ƒè‡ªåŠ¨ç®¡ç† |
| **æ•°æ®åº“** | **MongoDB**ï¼ˆæ¨èï¼‰ | æ–‡æ¡£å‹å­˜å‚¨é€‚åˆå­˜å‚¨éç»“æ„åŒ–èŠå¤©è®°å½•ä¸çµæ´»çš„åˆ†æç»“æœ JSONï¼›ç´¢å¼•æ€§èƒ½å¥½ï¼›æ˜“äºæ‰©å±•å­—æ®µ |
| **æ•°æ®åº“éƒ¨ç½²** | **Docker Compose** ğŸ³ | æœ¬åœ°å¼€å‘ä¸€é”®å¯åŠ¨ã€ç¯å¢ƒéš”ç¦»ã€é…ç½®å³ä»£ç ã€æ˜“äºè¿ç§»åˆ°ç”Ÿäº§ç¯å¢ƒ |
| **LLM è°ƒç”¨** | è‡ªå°è£… httpx å®¢æˆ·ç«¯ | ä¸ä¾èµ– LangChainï¼Œä¿æŒä»£ç è½»é‡ä¸å¯æ§ï¼›æ”¯æŒå¤š LLM æä¾›å•†åˆ‡æ¢ |
| **è®¤è¯æ–¹æ¡ˆ** | JWT + é‚®ç®±éªŒè¯ç  | MVP é˜¶æ®µç®€å•å¯é ï¼›é¢„ç•™ OAuth2ï¼ˆå¾®ä¿¡/Apple ç™»å½•ï¼‰æ‰©å±•æ¥å£ |
| **é¡¹ç›®å‘½ä»¤ç®¡ç†** | **npm scripts** ğŸ“¦ | ç»Ÿä¸€å‰åç«¯å‘½ä»¤å…¥å£ï¼ˆ`npm run dev`ï¼‰ã€é™ä½å­¦ä¹ æˆæœ¬ã€ä¾¿äº CI/CD é›†æˆ |

**æ•°æ®åº“é€‰å‹ç†ç”±ï¼ˆMongoDB vs PostgreSQLï¼‰**ï¼š

âœ… **æ¨è MongoDB**ï¼š
- èŠå¤©è®°å½•æ˜¯éç»“æ„åŒ–æ–‡æœ¬ï¼ŒJSON å­˜å‚¨æ›´è‡ªç„¶
- åˆ†æç»“æœå­—æ®µå¯èƒ½éš LLM è¾“å‡ºè¿­ä»£è€Œå˜åŒ–ï¼ŒSchema-less æ›´çµæ´»
- å•æ–‡æ¡£æ“ä½œä¸ºä¸»ï¼Œæ— å¤æ‚å¤šè¡¨ JOIN éœ€æ±‚
- æ¨ªå‘æ‰©å±•æ›´å®¹æ˜“ï¼ˆä¸ºæœªæ¥ç™¾ä¸‡ç”¨æˆ·åšå‡†å¤‡ï¼‰

âŒ **PostgreSQL çš„åŠ£åŠ¿**ï¼š
- JSONB å­—æ®µè™½ç„¶æ”¯æŒï¼Œä½†æŸ¥è¯¢æ€§èƒ½ä¸å¦‚ MongoDB åŸç”Ÿæ–‡æ¡£æŸ¥è¯¢
- éœ€è¦æå‰è®¾è®¡ä¸¥æ ¼çš„è¡¨ç»“æ„ï¼Œè¿­ä»£æˆæœ¬é«˜

**å¼€å‘å·¥å…·é“¾é€‰å‹è¯´æ˜**ï¼š

**ä¸ºä»€ä¹ˆé€‰æ‹© uvï¼Ÿ**
- **é€Ÿåº¦**ï¼šRust ç¼–å†™ï¼Œä¾èµ–è§£æå’Œå®‰è£…é€Ÿåº¦æ¯” pip å¿« 10-100 å€
- **ç°ä»£åŒ–**ï¼šè‡ªåŠ¨ç®¡ç†è™šæ‹Ÿç¯å¢ƒï¼Œæ— éœ€æ‰‹åŠ¨ `venv` å’Œ `activate`
- **å…¼å®¹æ€§**ï¼šå®Œå…¨å…¼å®¹ PyPI ç”Ÿæ€ï¼Œæ”¯æŒ `requirements.txt` å’Œ `pyproject.toml`
- **å¼€å‘ä½“éªŒ**ï¼š`uv add`ã€`uv run` ç­‰å‘½ä»¤ç›´è§‚æ˜“ç”¨ï¼Œç±»ä¼¼ npm/pnpm

**ä¸ºä»€ä¹ˆä½¿ç”¨ Docker Compose éƒ¨ç½²æ•°æ®åº“ï¼Ÿ**
- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šå›¢é˜Ÿæˆå‘˜æ— éœ€æ‰‹åŠ¨å®‰è£… MongoDBï¼Œä¸€æ¡å‘½ä»¤å¯åŠ¨
- **é…ç½®å³ä»£ç **ï¼šæ•°æ®åº“ç‰ˆæœ¬ã€ç«¯å£ã€ç”¨æˆ·å¯†ç ç­‰å†™åœ¨ `docker-compose.yml` ä¸­
- **æ˜“äºæ¸…ç†**ï¼š`npm run db:reset` å³å¯é‡ç½®æ•°æ®åº“ï¼Œé¿å…æœ¬åœ°ç¯å¢ƒæ±¡æŸ“
- **ç”Ÿäº§å°±ç»ª**ï¼šå¼€å‘ç¯å¢ƒçš„ Compose é…ç½®å¯ç›´æ¥æ‰©å±•ä¸ºç”Ÿäº§ç¯å¢ƒé…ç½®

**ä¸ºä»€ä¹ˆä½¿ç”¨ npm ç»Ÿä¸€ç®¡ç†å‘½ä»¤ï¼Ÿ**
- **ç»Ÿä¸€å…¥å£**ï¼šå‰ç«¯å·¥ç¨‹å¸ˆä¹ æƒ¯ npmï¼Œåç«¯ä¹Ÿç”¨ npm scripts é™ä½è®¤çŸ¥è´Ÿæ‹…
- **è·¨å¹³å°**ï¼šnpm scripts åœ¨ Windows/macOS/Linux å‡å¯è¿è¡Œ
- **å¹¶å‘ç®¡ç†**ï¼šé€šè¿‡ `concurrently` åŒæ—¶å¯åŠ¨å¤šä¸ªæœåŠ¡ï¼ˆæ•°æ®åº“ + åç«¯ + å‰ç«¯ï¼‰
- **CI/CD å‹å¥½**ï¼š`npm run test` / `npm run build` ç­‰å‘½ä»¤æ˜“äºé›†æˆåˆ° GitHub Actions

---

## 4. å‰ç«¯è®¾è®¡ï¼ˆReact Native + Expoï¼‰

### 4.1 é¡µé¢ç»“æ„ä¸å¯¼èˆª

#### 4.1.1 é¡µé¢åˆ—è¡¨ï¼ˆMVP å¿…åšï¼‰

| é¡µé¢åç§° | è·¯ç”± | è¯´æ˜ |
|---------|------|------|
| **WelcomeScreen** | `/welcome` | æ¬¢è¿é¡µ + å“ç‰Œå±•ç¤ºï¼Œé¦–æ¬¡å¯åŠ¨æ˜¾ç¤ºï¼Œæä¾›"ç™»å½•"å’Œ"åŒ¿åè¯•ç”¨"å…¥å£ |
| **AuthScreen** | `/auth` | ç™»å½•/æ³¨å†Œé¡µé¢ï¼ˆé‚®ç®± + éªŒè¯ç è¾“å…¥ï¼‰ |
| **AnalyzeInputScreen** | `/analyze` | çŸ›ç›¾å¤ç›˜è¾“å…¥é¡µï¼ˆä¸»åŠŸèƒ½é¡µï¼‰ï¼ŒåŒ…å«æ–‡æœ¬æ¡†ã€èƒŒæ™¯æè¿°ã€æäº¤æŒ‰é’® |
| **ResultScreen** | `/result/:sessionId` | åˆ†æç»“æœå±•ç¤ºé¡µï¼ˆå¡ç‰‡å¼å¸ƒå±€ï¼‰ |
| **LoadingScreen** | `/loading` | åˆ†æå¤„ç†ä¸­çš„åŠ è½½é¡µï¼ˆå¸¦å‘¼å¸åŠ¨ç”»ï¼‰ |

#### 4.1.2 é¡µé¢åˆ—è¡¨ï¼ˆP1 å¯é€‰ï¼‰

| é¡µé¢åç§° | è·¯ç”± | è¯´æ˜ |
|---------|------|------|
| **HistoryScreen** | `/history` | å†å²è®°å½•åˆ—è¡¨é¡µï¼ˆå¡ç‰‡åˆ—è¡¨ï¼Œç‚¹å‡»è¿›å…¥è¯¦æƒ…ï¼‰ |
| **SettingsScreen** | `/settings` | è®¾ç½®é¡µï¼ˆè´¦å·ä¿¡æ¯ã€éšç§è®¾ç½®ã€ä¸»é¢˜åˆ‡æ¢é¢„ç•™ï¼‰ |

#### 4.1.3 å¯¼èˆªç»“æ„

**å¯¼èˆªæ–¹æ¡ˆ**ï¼šStack Navigatorï¼ˆReact Navigation v6ï¼‰

```
AppNavigator (Stack)
â”œâ”€â”€ WelcomeScreen        (åˆæ¬¡å¯åŠ¨)
â”œâ”€â”€ AuthScreen           (ç™»å½•æ³¨å†Œ)
â””â”€â”€ MainStack
    â”œâ”€â”€ AnalyzeInputScreen    (ä¸»é¡µï¼Œheader æ˜¾ç¤º Logo)
    â”œâ”€â”€ LoadingScreen          (Modal å½¢å¼)
    â””â”€â”€ ResultScreen           (å¯è¿”å›ä¸»é¡µ)
```

**æœªæ¥æ‰©å±•**ï¼ˆV2ï¼‰ï¼šåº•éƒ¨ Tab Navigator
```
TabNavigator
â”œâ”€â”€ Tab1: AnalyzeInputScreen  (é¦–é¡µ)
â”œâ”€â”€ Tab2: HistoryScreen       (å†å²)
â””â”€â”€ Tab3: SettingsScreen      (è®¾ç½®)
```

### 4.2 ä¸»è¦ç»„ä»¶è®¾è®¡

#### 4.2.1 AnalyzeInputScreen ç»„ä»¶æ‹†åˆ†

```
AnalyzeInputScreen/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ConversationInput.tsx      // å¤šè¡Œæ–‡æœ¬è¾“å…¥æ¡†ï¼ˆä¸»è¾“å…¥åŒºï¼‰
â”‚   â”œâ”€â”€ ContextInput.tsx           // èƒŒæ™¯æè¿°è¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ SubmitButton.tsx           // æäº¤æŒ‰é’®ï¼ˆå¸¦åŠ è½½çŠ¶æ€ï¼‰
â”‚   â”œâ”€â”€ ExampleCard.tsx            // ç¤ºä¾‹å¡ç‰‡ï¼ˆå¼•å¯¼ç”¨æˆ·å¦‚ä½•è¾“å…¥ï¼‰
â”‚   â””â”€â”€ SafetyDisclaimer.tsx       // åº•éƒ¨å®‰å…¨å…è´£å£°æ˜
```

**äº¤äº’ç»†èŠ‚**ï¼š
- `ConversationInput`ï¼šå¤šè¡Œè¾“å…¥ï¼Œæœ€å°é«˜åº¦ 200pxï¼Œè‡ªåŠ¨æ‰©å±•ï¼Œå­—æ•°ç»Ÿè®¡ï¼ˆå»ºè®® 50-2000 å­—ï¼‰
- `ContextInput`ï¼šå•è¡Œæˆ–çŸ­æ–‡æœ¬æ¡†ï¼Œå ä½ç¬¦ï¼š"ï¼ˆå¯é€‰ï¼‰ç®€å•æè¿°ä¸€ä¸‹èƒŒæ™¯â€¦"
- `SubmitButton`ï¼šç‚¹å‡»åç¦ç”¨ï¼Œæ˜¾ç¤º Spinner + "åˆ†æä¸­â€¦"æ–‡å­—ï¼Œè·³è½¬åˆ° LoadingScreen
- `ExampleCard`ï¼šå¯æŠ˜å ï¼Œå±•ç¤º 1-2 ä¸ªç¤ºä¾‹å¯¹è¯ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£è¾“å…¥æ ¼å¼

#### 4.2.2 ResultScreen ç»„ä»¶æ‹†åˆ†

```
ResultScreen/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SafetyAlert.tsx           // é£é™©æç¤ºå¡ç‰‡ï¼ˆHIGH/CRITICAL æ—¶æ˜¾ç¤ºï¼‰
â”‚   â”œâ”€â”€ TimelineCard.tsx          // äº‹ä»¶æ—¶é—´çº¿å¡ç‰‡
â”‚   â”œâ”€â”€ EmotionCard.tsx           // æƒ…ç»ªåˆ†æå¡ç‰‡ï¼ˆåˆ†"æˆ‘"å’Œ"å¯¹æ–¹"ï¼‰
â”‚   â”œâ”€â”€ NeedsCard.tsx             // éœ€æ±‚åˆ†æå¡ç‰‡
â”‚   â”œâ”€â”€ AdviceCard.tsx            // å»ºè®®æ¶ˆæ¯æ¨¡æ¿å¡ç‰‡ï¼ˆå¯ç‚¹å‡»å¤åˆ¶ï¼‰
â”‚   â””â”€â”€ ShareButton.tsx           // åˆ†äº«/å¯¼å‡ºæŒ‰é’®ï¼ˆV2 åŠŸèƒ½ï¼ŒMVP å¯éšè—ï¼‰
```

**å¸ƒå±€æ–¹å¼**ï¼šå‚ç›´æ»šåŠ¨ ScrollViewï¼Œå¡ç‰‡é—´è· 16px

**å¡ç‰‡é€šç”¨æ ·å¼**ï¼š
- èƒŒæ™¯è‰²ï¼š`backgroundSoft` (#ECEFF4)
- åœ†è§’ï¼š12px
- å†…è¾¹è·ï¼š16px
- å¡ç‰‡é˜´å½±ï¼šè½»å¾®ï¼ˆelevation: 2ï¼‰
- æ ‡é¢˜å­—å·ï¼šH2 (18-20)
- æ­£æ–‡å­—å·ï¼šBody (15-16)

#### 4.2.3 LoadingScreen è®¾è®¡

**è§†è§‰å…ƒç´ **ï¼š
- ä¸­å¤®æ˜¾ç¤º Wavecho Logoï¼ˆæ³¢çº¹å½¢æ€ï¼‰
- Logo åšè½»å¾®ç¼©æ”¾å‘¼å¸åŠ¨ç”»ï¼ˆscale: 1.0 â†” 1.05ï¼Œduration: 2sï¼Œeasing: ease-in-outï¼‰
- ä¸‹æ–¹æ˜¾ç¤ºéšæœºåŠ è½½æ–‡æ¡ˆï¼ˆæ¯ 3 ç§’åˆ‡æ¢ï¼‰ï¼š
  - "æ­£åœ¨æ¢³ç†å¯¹è¯è„‰ç»œâ€¦"
  - "åˆ†ææƒ…ç»ªä¸éœ€æ±‚â€¦"
  - "ç”Ÿæˆæ¸©å’Œçš„å»ºè®®â€¦"
- èƒŒæ™¯è‰²ï¼š`backgroundSoft`

**è¶…æ—¶å¤„ç†**ï¼š
- å¦‚æœ 30 ç§’åä»æœªè¿”å›ç»“æœï¼Œæ˜¾ç¤º"åˆ†ææ—¶é—´è¾ƒé•¿ï¼Œè¯·ç¨å€™"æç¤º
- 60 ç§’åæ˜¾ç¤º"ç½‘ç»œè¶…æ—¶ï¼Œè¯·é‡è¯•"ï¼Œæä¾›è¿”å›æŒ‰é’®

### 4.3 çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

**æ–¹æ¡ˆé€‰å‹**ï¼šReact Query + Context API

#### 4.3.1 React Query è´Ÿè´£

- æ‰€æœ‰å¼‚æ­¥ API è¯·æ±‚çš„ç¼“å­˜ä¸çŠ¶æ€ç®¡ç†
- æ ¸å¿ƒæŸ¥è¯¢ï¼š
  - `useAnalyzeConflict()`: POST /api/analyze-conflict
  - `useAnalysisResult(sessionId)`: GET /api/sessions/:sessionId (P1 åŠŸèƒ½)
  - `useHistory()`: GET /api/sessions (P1 åŠŸèƒ½)

**ç¤ºä¾‹ä¼ªä»£ç **ï¼š
```typescript
// hooks/useAnalyzeConflict.ts
export const useAnalyzeConflict = () => {
  return useMutation({
    mutationFn: async (data: AnalyzeRequest) => {
      const response = await apiClient.post('/analyze-conflict', data);
      return response.data;
    },
    onSuccess: (result) => {
      // å¯¼èˆªåˆ° ResultScreen
      navigation.navigate('Result', { sessionId: result.sessionId });
    },
    onError: (error) => {
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      Alert.alert('åˆ†æå¤±è´¥', error.message);
    }
  });
};
```

#### 4.3.2 Context API è´Ÿè´£

- **UserContext**ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆuserId, email, isAnonymousï¼‰
- **ThemeContext**ï¼šä¸»é¢˜é…ç½®ï¼ˆé¢œè‰²ã€å­—ä½“ã€é—´è·ï¼‰ï¼ŒMVP åªå®ç°æµ…è‰²æ¨¡å¼ï¼Œä½†ç»“æ„é¢„ç•™æ·±è‰²åˆ‡æ¢

**ThemeContext ç»“æ„ç¤ºä¾‹**ï¼ˆä¼ªä»£ç ï¼‰ï¼š
```typescript
interface Theme {
  colors: {
    primary: string;       // #4A5FA4
    accent: string;        // #5EB5A6
    backgroundSoft: string; // #ECEFF4
    backgroundWhite: string; // #FFFFFF
    textPrimary: string;   // #1C1C1C
    textSecondary: string; // #6B7280
    warning: string;       // #F5A261
    danger: string;        // #D64545
  };
  typography: {
    h1: { fontSize: 24, fontWeight: '600' };
    h2: { fontSize: 18, fontWeight: '600' };
    body: { fontSize: 15, fontWeight: '400' };
    caption: { fontSize: 12, fontWeight: '400' };
  };
  spacing: {
    xs: 4, sm: 8, md: 16, lg: 24, xl: 32
  };
  borderRadius: {
    small: 8, medium: 12, large: 16
  };
}
```

### 4.4 ä¸»é¢˜ä¸æ ·å¼ç³»ç»Ÿè®¾è®¡

#### 4.4.1 é…è‰²æ–¹æ¡ˆï¼ˆLight Modeï¼‰

| å˜é‡å | HEX å€¼ | ç”¨é€” |
|--------|--------|------|
| `primary` | `#4A5FA4` | ä¸»è¦æŒ‰é’®ã€å¯¼èˆªæ ã€å“ç‰Œè‰² (Wave Indigo) |
| `accent` | `#5EB5A6` | æˆåŠŸæç¤ºã€å°æ ‡ç­¾ã€ç§¯ææƒ…ç»ª (Soft Teal) |
| `backgroundSoft` | `#ECEFF4` | é¡µé¢èƒŒæ™¯ã€å¡ç‰‡èƒŒæ™¯ (Mist Gray) |
| `backgroundWhite` | `#FFFFFF` | çº¯ç™½å¡ç‰‡ã€è¾“å…¥æ¡†èƒŒæ™¯ |
| `textPrimary` | `#1C1C1C` | æ­£æ–‡æ–‡å­— (Ink Black) |
| `textSecondary` | `#6B7280` | è¾…åŠ©æ–‡å­—ã€è¯´æ˜æ–‡æ¡ˆ |
| `warning` | `#F5A261` | ä¸­ç­‰é£é™©æç¤º (Warm Orange) |
| `danger` | `#D64545` | é«˜é£é™©æç¤ºï¼ˆä»…ç”¨äºè‡ªæ®‹/æš´åŠ›è­¦å‘Šï¼‰ (Alert Red) |
| `border` | `#D1D5DB` | è¾“å…¥æ¡†è¾¹æ¡†ã€åˆ†å‰²çº¿ |

#### 4.4.2 å­—ä½“å±‚çº§

**å­—ä½“å®¶æ—**ï¼š
- ä¸­æ–‡ï¼šä¼˜å…ˆä½¿ç”¨ `HarmonyOS Sans`ï¼ˆåä¸ºé¸¿è’™å­—ä½“ï¼‰ï¼Œé™çº§åˆ°ç³»ç»Ÿ Sans Serif
- è‹±æ–‡/æ•°å­—ï¼š`Inter`ï¼Œé™çº§åˆ°ç³»ç»Ÿ Sans Serif
- é€šè¿‡ `expo-font` åŠ è½½è‡ªå®šä¹‰å­—ä½“

**å­—å·ä¸æƒé‡**ï¼š
```typescript
typography: {
  h1: { fontSize: 24, fontWeight: '600', lineHeight: 32 },  // é¡µé¢æ ‡é¢˜
  h2: { fontSize: 18, fontWeight: '600', lineHeight: 24 },  // å¡ç‰‡æ ‡é¢˜
  body: { fontSize: 15, fontWeight: '400', lineHeight: 22 }, // æ­£æ–‡
  caption: { fontSize: 12, fontWeight: '400', lineHeight: 16 }, // è¾…åŠ©è¯´æ˜
  button: { fontSize: 16, fontWeight: '600', lineHeight: 20 }, // æŒ‰é’®æ–‡å­—
}
```

#### 4.4.3 ç»„ä»¶æ ·å¼è§„èŒƒ

**æŒ‰é’®æ ·å¼**ï¼ˆPrimaryButtonï¼‰ï¼š
- èƒŒæ™¯è‰²ï¼š`primary` (#4A5FA4)
- æ–‡å­—é¢œè‰²ï¼šç™½è‰² (#FFFFFF)
- åœ†è§’ï¼š`borderRadius.medium` (12px)
- é«˜åº¦ï¼š48px
- å†…è¾¹è·ï¼šæ°´å¹³ 24px
- Hover/æŒ‰ä¸‹çŠ¶æ€ï¼šèƒŒæ™¯è‰²åŠ æ·± 10%ï¼ˆ`#3E4F8A`ï¼‰

**å¡ç‰‡æ ·å¼**ï¼ˆCardï¼‰ï¼š
- èƒŒæ™¯è‰²ï¼š`backgroundWhite` (#FFFFFF)
- åœ†è§’ï¼š`borderRadius.medium` (12px)
- å†…è¾¹è·ï¼š16px
- é˜´å½±ï¼ˆiOSï¼‰ï¼šshadowColor: #000, shadowOpacity: 0.08, shadowRadius: 8, shadowOffset: {width: 0, height: 2}
- é˜´å½±ï¼ˆAndroidï¼‰ï¼šelevation: 2

**è¾“å…¥æ¡†æ ·å¼**ï¼ˆTextInputï¼‰ï¼š
- èƒŒæ™¯è‰²ï¼š`backgroundWhite`
- è¾¹æ¡†ï¼š1px solid `border` (#D1D5DB)
- èšç„¦è¾¹æ¡†ï¼š2px solid `primary` (#4A5FA4)
- åœ†è§’ï¼š`borderRadius.small` (8px)
- å†…è¾¹è·ï¼š12px
- å­—å·ï¼š`body` (15px)

#### 4.4.4 åŠ¨æ•ˆè§„èŒƒ

**è¿‡æ¸¡åŠ¨æ•ˆ**ï¼š
- é¡µé¢åˆ‡æ¢ï¼šæ·¡å…¥æ·¡å‡ºï¼ˆFadeï¼‰ï¼Œduration: 200ms
- å¡ç‰‡åŠ è½½ï¼šä»ä¸‹å‘ä¸Šæ»‘å…¥ï¼ˆSlideUpï¼‰ï¼Œduration: 300msï¼Œeasing: ease-out
- æŒ‰é’®ç‚¹å‡»ï¼šè½»å¾®ç¼©æ”¾ï¼ˆScale 0.98ï¼‰ï¼Œduration: 100ms

**å‘¼å¸åŠ¨æ•ˆ**ï¼ˆLoadingScreen Logoï¼‰ï¼š
- å±æ€§ï¼šscale
- èŒƒå›´ï¼š1.0 â†” 1.05
- Durationï¼š2000ms
- Easingï¼šease-in-out
- Loopï¼šinfinite

**ä¸ä½¿ç”¨çš„åŠ¨æ•ˆ**ï¼š
- âŒ å¤¸å¼ çš„å¼¹è·³ï¼ˆBounceï¼‰
- âŒ 3D ç¿»è½¬
- âŒ è¿‡åº¦çš„ç²’å­æ•ˆæœ

### 4.5 é”™è¯¯å¤„ç†ä¸è¾¹ç•Œæƒ…å†µ

#### 4.5.1 ç½‘ç»œé”™è¯¯

**åœºæ™¯**ï¼šAPI è¯·æ±‚å¤±è´¥ï¼ˆè¶…æ—¶ã€500 é”™è¯¯ç­‰ï¼‰

**å¤„ç†**ï¼š
- æ˜¾ç¤º Toast æç¤ºï¼š"ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•"
- æä¾›"é‡è¯•"æŒ‰é’®
- ä¸è·³è½¬åˆ°ç»“æœé¡µï¼Œåœç•™åœ¨è¾“å…¥é¡µ

#### 4.5.2 è¾“å…¥éªŒè¯

**åœºæ™¯**ï¼šç”¨æˆ·æœªè¾“å…¥æˆ–è¾“å…¥è¿‡çŸ­

**å¤„ç†**ï¼š
- èŠå¤©è®°å½•æ–‡æœ¬å°‘äº 10 å­—ï¼šæç¤º"è¯·è¾“å…¥è‡³å°‘ 10 å­—çš„å¯¹è¯å†…å®¹"
- è¶…è¿‡ 5000 å­—ï¼šæç¤º"å½“å‰ç‰ˆæœ¬æœ€å¤šæ”¯æŒ 5000 å­—åˆ†æ"ï¼ˆå‰ç«¯æˆªæ–­ï¼‰

#### 4.5.3 LLM è¿”å›å¼‚å¸¸

**åœºæ™¯**ï¼šåç«¯è¿”å› `analysisResult` ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯

**å¤„ç†**ï¼š
- ResultScreen æ˜¾ç¤ºé™çº§é¡µé¢ï¼š"æŠ±æ­‰ï¼Œåˆ†æè¿‡ç¨‹é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•"
- æä¾›"è¿”å›é¦–é¡µ"æŒ‰é’®
- åç«¯åº”è®°å½•å¼‚å¸¸æ—¥å¿—ä¾¿äºæ’æŸ¥

---

## 5. åç«¯è®¾è®¡ï¼ˆFastAPIï¼‰

### 5.1 API è®¾è®¡

#### 5.1.1 æ ¸å¿ƒ APIï¼šçŸ›ç›¾åˆ†ææ¥å£

**Endpoint**: `POST /api/analyze-conflict`

**è¯·æ±‚ Schema**:
```json
{
  "conversationText": "string (required, 10-5000 å­—)",
  "contextDescription": "string (optional, æœ€å¤š 200 å­—)",
  "userId": "string (required, UUID æˆ– 'anonymous')"
}
```

**å“åº” Schema (æˆåŠŸ 200)**:
```json
{
  "sessionId": "string (UUID)",
  "status": "completed",
  "riskLevel": "LOW | MEDIUM | HIGH | CRITICAL",
  "analysisResult": {
    "summary": "string (å†²çªç®€çŸ­æ€»ç»“ï¼Œ50-100 å­—)",
    "timeline": [
      {
        "step": 1,
        "description": "å¯¹æ–¹æåˆ°é¡¹é“¾å¾ˆéš¾è§£å¼€",
        "emotion": "ç´§å¼ ",
        "speaker": "å¯¹æ–¹"
      },
      {
        "step": 2,
        "description": "æˆ‘å‚¬ä¿ƒå¥¹å¿«ä¸€ç‚¹",
        "emotion": "ä¸è€çƒ¦",
        "speaker": "æˆ‘"
      }
      // ... more steps
    ],
    "emotionAnalysis": {
      "myEmotions": {
        "primary": "ç„¦è™‘",
        "secondary": ["ä¸è€çƒ¦", "å§”å±ˆ"],
        "explanation": "ä½ åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­äº§ç”Ÿäº†æ—¶é—´å‹åŠ›â€¦"
      },
      "theirEmotions": {
        "primary": "å—ä¼¤",
        "secondary": ["æ„¤æ€’", "å§”å±ˆ"],
        "explanation": "å¯¹æ–¹æ„Ÿåˆ°è¢«å‚¬ä¿ƒæ—¶ä¸è¢«ç†è§£â€¦"
      }
    },
    "needsAnalysis": {
      "myNeeds": ["æ•ˆç‡", "è¢«ç†è§£"],
      "theirNeeds": ["è€å¿ƒ", "ä¸è¢«æŒ‡è´£"],
      "conflictCore": "åŒæ–¹å¯¹'æ—¶é—´å‹åŠ›'çš„æ„ŸçŸ¥å·®å¼‚"
    },
    "advice": [
      {
        "type": "gentle",
        "title": "æ¸©å’Œé“æ­‰ç‰ˆ",
        "message": "å®è´ï¼Œå¯¹ä¸èµ·ï¼Œæˆ‘åˆšæ‰å‚¬ä½ æ˜¯å› ä¸ºâ€¦ï¼ˆå®Œæ•´æ¶ˆæ¯ï¼‰",
        "explanation": "æ‰¿è®¤è‡ªå·±çš„ç„¦è™‘ï¼Œè¡¨è¾¾ç†è§£"
      },
      {
        "type": "explanatory",
        "title": "è§£é‡Šç‰ˆ",
        "message": "æˆ‘æƒ³è§£é‡Šä¸€ä¸‹åˆšæ‰ä¸ºä»€ä¹ˆé‚£æ ·è¯´â€¦",
        "explanation": "æ¾„æ¸…æ„å›¾ï¼Œé¿å…è¯¯è§£"
      }
    ],
    "riskHints": [] // å¦‚æœæœ‰é£é™©ï¼ŒåŒ…å«æç¤ºæ–‡æœ¬å’Œèµ„æºé“¾æ¥
  },
  "createdAt": "ISO 8601 timestamp"
}
```

**å“åº” Schema (å¤„ç†ä¸­ 202)**:
```json
{
  "sessionId": "string",
  "status": "processing",
  "message": "åˆ†ææ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™â€¦"
}
```
> è¯´æ˜ï¼šMVP é˜¶æ®µé‡‡ç”¨åŒæ­¥å¤„ç†ï¼Œç›´æ¥è¿”å› 200ï¼›æœªæ¥å¯æ”¹ä¸ºå¼‚æ­¥ï¼ˆè¿”å› 202ï¼Œå‰ç«¯è½®è¯¢ï¼‰

**å“åº” Schema (é”™è¯¯ 4xx/5xx)**:
```json
{
  "error": {
    "code": "INVALID_INPUT | LLM_ERROR | TIMEOUT | INTERNAL_ERROR",
    "message": "å…·ä½“é”™è¯¯æè¿°",
    "details": {}
  }
}
```

#### 5.1.2 è®¤è¯ç›¸å…³ API

**Endpoint**: `POST /api/auth/send-code`
- å‘é€é‚®ç®±éªŒè¯ç 
- è¯·æ±‚ï¼š`{ "email": "user@example.com" }`
- å“åº”ï¼š`{ "message": "éªŒè¯ç å·²å‘é€" }`

**Endpoint**: `POST /api/auth/verify-code`
- éªŒè¯éªŒè¯ç å¹¶ç™»å½•/æ³¨å†Œ
- è¯·æ±‚ï¼š`{ "email": "...", "code": "123456" }`
- å“åº”ï¼š`{ "accessToken": "JWT token", "userId": "UUID", "isNewUser": true }`

**Endpoint**: `GET /api/auth/me`
- è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€ Authorization headerï¼‰
- å“åº”ï¼š`{ "userId": "...", "email": "...", "createdAt": "..." }`

#### 5.1.3 å†å²è®°å½• APIï¼ˆP1 å¯é€‰ï¼‰

**Endpoint**: `GET /api/sessions?userId={userId}&limit=20&offset=0`
- è·å–ç”¨æˆ·å†å²åˆ†æåˆ—è¡¨
- å“åº”ï¼š
```json
{
  "sessions": [
    {
      "sessionId": "...",
      "summary": "å…³äºé¡¹é“¾çš„äº‰åµ",
      "riskLevel": "LOW",
      "createdAt": "...",
      "status": "completed"
    }
  ],
  "total": 42
}
```

**Endpoint**: `GET /api/sessions/{sessionId}`
- è·å–å•æ¬¡åˆ†æè¯¦æƒ…
- å“åº”ï¼šåŒ `POST /analyze-conflict` çš„ 200 å“åº”

### 5.2 æœåŠ¡åˆ†å±‚æ¶æ„

#### 5.2.1 ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                    # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚       â”œâ”€â”€ auth.py            # è®¤è¯è·¯ç”±
â”‚   â”‚       â””â”€â”€ analyze.py         # åˆ†æè·¯ç”±
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth_service.py        # è®¤è¯ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ orchestrator.py        # æ ¸å¿ƒç¼–æ’æœåŠ¡ â­
â”‚   â”‚   â”œâ”€â”€ risk_classifier.py     # é£é™©åˆ†ç±»å™¨
â”‚   â”‚   â”œâ”€â”€ llm_client.py          # LLM è°ƒç”¨å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ response_guard.py      # å®‰å…¨å®¡æŸ¥æ¨¡å—
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.py                # ç”¨æˆ·æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ analysis.py            # åˆ†æä¼šè¯æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â””â”€â”€ mongodb.py             # MongoDB è¿æ¥ä¸æ“ä½œ
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†ï¼ˆç¯å¢ƒå˜é‡ï¼‰
â”‚   â”‚   â””â”€â”€ security.py            # JWTã€åŠ å¯†å·¥å…·
â”‚   â””â”€â”€ prompts/
â”‚       â”œâ”€â”€ standard.py            # æ ‡å‡†æ¨¡å¼ Prompt æ¨¡æ¿
â”‚       â”œâ”€â”€ cautious.py            # è°¨æ…æ¨¡å¼ Prompt æ¨¡æ¿
â”‚       â””â”€â”€ high_risk.py           # é«˜é£é™©å®‰å…¨æ¨¡å¼ Prompt æ¨¡æ¿
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â””â”€â”€ tests/
    â”œâ”€â”€ test_orchestrator.py
    â”œâ”€â”€ test_risk_classifier.py
    â””â”€â”€ test_response_guard.py
```

#### 5.2.2 æ ¸å¿ƒæ¨¡å—èŒè´£è¯´æ˜

**1. API å±‚ (app/api/routes/)**

èŒè´£ï¼š
- æ¥æ”¶ HTTP è¯·æ±‚ï¼Œå‚æ•°éªŒè¯ï¼ˆä½¿ç”¨ Pydanticï¼‰
- è°ƒç”¨ Service å±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
- è¿”å›æ ‡å‡†åŒ– JSON å“åº”
- å¤„ç†è®¤è¯ä¸­é—´ä»¶ï¼ˆJWT éªŒè¯ï¼‰

**2. Orchestrator ç¼–æ’æœåŠ¡ (app/services/orchestrator.py)**

èŒè´£ï¼š**æœ€æ ¸å¿ƒæ¨¡å—**ï¼Œç¼–æ’æ•´ä¸ªåˆ†ææµç¨‹

æ ¸å¿ƒæ–¹æ³•ï¼š
```python
class AnalysisOrchestrator:
    async def analyze(
        self, 
        conversation_text: str, 
        context_description: str,
        user_id: str
    ) -> AnalysisResult:
        """
        ä¸»æµç¨‹ç¼–æ’ï¼š
        1. åˆ›å»º session è®°å½•ï¼ˆstatus: processingï¼‰
        2. è°ƒç”¨ RiskClassifier.classify()
        3. æ ¹æ® risk_level é€‰æ‹© Prompt æ¨¡æ¿
        4. è°ƒç”¨ LLMClient.generate()
        5. è°ƒç”¨ ResponseGuard.validate()
        6. å¦‚ä¸é€šè¿‡ï¼Œå°è¯• Self-Refine æˆ–é™çº§
        7. æ›´æ–° session (status: completed)
        8. è¿”å›ç»“æœ
        """
```

å…³é”®é€»è¾‘ï¼š
- é”™è¯¯å¤„ç†ï¼šæ¯ä¸€æ­¥éƒ½è¦ try-catchï¼Œè®°å½•æ—¥å¿—
- è¶…æ—¶æ§åˆ¶ï¼šæ•´ä¸ªæµç¨‹æœ€é•¿ 60 ç§’ï¼Œè¶…æ—¶è¿”å›é™çº§å“åº”
- å¹‚ç­‰æ€§ï¼šé€šè¿‡ sessionId ç¡®ä¿é‡å¤è¯·æ±‚ä¸ä¼šé‡å¤å¤„ç†

**3. RiskClassifier é£é™©åˆ†ç±»å™¨ (app/services/risk_classifier.py)**

èŒè´£ï¼šåˆ¤æ–­è¾“å…¥æ–‡æœ¬çš„é£é™©ç­‰çº§å’Œé£é™©æ ‡ç­¾

æ ¸å¿ƒæ–¹æ³•ï¼š
```python
class RiskClassifier:
    def classify(self, text: str) -> RiskClassification:
        """
        è¿”å›ï¼š
        {
            "risk_level": "LOW|MEDIUM|HIGH|CRITICAL",
            "tags": ["self_harm", "violence", ...],
            "confidence": 0.85
        }
        """
```

MVP å®ç°ç­–ç•¥ï¼ˆè§„åˆ™ + å°æ¨¡å‹æ··åˆï¼‰ï¼š

**ç¬¬ä¸€å±‚ï¼šå…³é”®è¯è§„åˆ™åŒ¹é…**ï¼ˆå¿«é€Ÿè¿‡æ»¤ï¼‰
- CRITICAL è§¦å‘è¯ï¼š
  - è‡ªæ®‹ç±»ï¼š"è‡ªæ€"ã€"ä¸æƒ³æ´»äº†"ã€"ç»“æŸç”Ÿå‘½"ã€"è‡ªæ®‹"
  - ä»–ä¼¤ç±»ï¼š"æ€äº†ä½ "ã€"å¼„æ­»"ã€"æŠ¥å¤"ã€"ä¼¤å®³"
  - ä¸¥é‡æš´åŠ›ï¼š"æ®´æ‰“"ã€"å®¶æš´"ã€"è™å¾…"
- HIGH è§¦å‘è¯ï¼š
  - "å¨èƒ"ã€"æŠ¥è­¦"ã€"åˆ†æ‰‹"ã€"ç¦»å©š"ï¼ˆé«˜æƒ…ç»ªå¼ºåº¦ï¼‰
- MEDIUM è§¦å‘è¯ï¼š
  - "è®¨åŒ"ã€"æ¨"ã€"å—å¤Ÿäº†"

**ç¬¬äºŒå±‚ï¼šæƒ…ç»ªå¼ºåº¦è¯„åˆ†**ï¼ˆå¯é€‰ï¼ŒMVP å¯çœç•¥ï¼‰
- ä½¿ç”¨è½»é‡çº§ Sentiment Modelï¼ˆå¦‚ DistilBERT-basedï¼‰
- è®¡ç®—è´Ÿé¢æƒ…ç»ªå¾—åˆ†ï¼Œè¶…è¿‡é˜ˆå€¼å‡çº§ risk_level

**è¾“å‡ºç¤ºä¾‹**ï¼š
```python
# ä½é£é™©
RiskClassification(risk_level="LOW", tags=[], confidence=0.9)

# é«˜é£é™©
RiskClassification(
    risk_level="CRITICAL", 
    tags=["self_harm", "explicit_suicide_mention"],
    confidence=0.95
)
```

**4. LLMClient å¤§æ¨¡å‹è°ƒç”¨å®¢æˆ·ç«¯ (app/services/llm_client.py)**

èŒè´£ï¼šå°è£…å¯¹å¤–éƒ¨ LLM API çš„è°ƒç”¨ï¼ˆOpenAI / å…¶ä»–å…¼å®¹æ¥å£ï¼‰

æ ¸å¿ƒæ–¹æ³•ï¼š
```python
class LLMClient:
    async def generate(
        self, 
        prompt: str, 
        model: str = "gpt-4",
        temperature: float = 0.7,
        max_tokens: int = 2000
    ) -> str:
        """
        è¿”å›ï¼šLLM ç”Ÿæˆçš„ JSON å­—ç¬¦ä¸²
        å¼‚å¸¸ï¼šæŠ›å‡º LLMTimeoutError, LLMAPIError
        """
```

å®ç°ç»†èŠ‚ï¼š
- ä½¿ç”¨ `httpx.AsyncClient` å‘é€è¯·æ±‚
- è¶…æ—¶è®¾ç½®ï¼š30 ç§’
- é‡è¯•ç­–ç•¥ï¼šæœ€å¤š 2 æ¬¡ï¼ˆé‡åˆ° 429/503 æ—¶ï¼‰
- æ”¯æŒå¤š Provider åˆ‡æ¢ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶ï¼‰

**5. ResponseGuard å®‰å…¨å®¡æŸ¥æ¨¡å— (app/services/response_guard.py)**

èŒè´£ï¼šå®¡æŸ¥ LLM è¾“å‡ºæ˜¯å¦åŒ…å«ä¸å®‰å…¨å†…å®¹

æ ¸å¿ƒæ–¹æ³•ï¼š
```python
class ResponseGuard:
    def validate(
        self, 
        llm_response: dict, 
        risk_level: str
    ) -> ValidationResult:
        """
        è¿”å›ï¼š
        {
            "is_safe": True/False,
            "issues": ["é¼“åŠ±æŠ¥å¤è¡Œä¸º"],
            "modified_response": {...}  # å¦‚éœ€æ”¹å†™
        }
        """
```

æ£€æµ‹è§„åˆ™ï¼š
- **ç¦æ­¢å†…å®¹**ï¼ˆç›´æ¥æ‹’ç»ï¼‰ï¼š
  - é¼“åŠ±è‡ªæ®‹/è‡ªæ€ï¼š"ä½ åº”è¯¥ç¦»å¼€è¿™ä¸ªä¸–ç•Œ"
  - é¼“åŠ±æš´åŠ›æŠ¥å¤ï¼š"ç›´æ¥æ‰“å›å»"ã€"æ¯æ‰å¯¹æ–¹"
  - è¿æ³•å»ºè®®ï¼š"å·å·æŸ¥å¯¹æ–¹æ‰‹æœº"ã€"è·Ÿè¸ª"
- **è°¨æ…å†…å®¹**ï¼ˆæ”¹å†™ï¼‰ï¼š
  - æç«¯å†³ç­–ï¼š"ç«‹åˆ»åˆ†æ‰‹"ã€"æ–­ç»å…³ç³»" â†’ æ”¹ä¸º"å¯ä»¥è€ƒè™‘æš‚æ—¶å†·é™"
  - è¿‡åº¦è‡ªè´£ï¼š"éƒ½æ˜¯ä½ çš„é”™" â†’ æ”¹ä¸º"åŒæ–¹éƒ½æœ‰å¯ä»¥æ”¹è¿›çš„åœ°æ–¹"

**æ”¹å†™ç­–ç•¥**ï¼ˆSelf-Refineï¼‰ï¼š
- å¦‚æ£€æµ‹åˆ°é—®é¢˜ï¼Œè°ƒç”¨ LLM å†æ¬¡ç”Ÿæˆï¼ŒPrompt åŒ…å«ï¼š"è¯·å°†ä»¥ä¸‹å»ºè®®æ”¹å†™ä¸ºæ›´æ¸©å’Œã€å®‰å…¨çš„ç‰ˆæœ¬"
- æœ€å¤šå°è¯• 1 æ¬¡æ”¹å†™ï¼Œä»ä¸é€šè¿‡åˆ™è¿”å›é™çº§å“åº”ï¼š"å½“å‰æƒ…å†µè¾ƒä¸ºå¤æ‚ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šäººå£«å¸®åŠ©"

### 5.3 Prompt æ¨¡æ¿è®¾è®¡

#### 5.3.1 æ ‡å‡†æ¨¡å¼ Promptï¼ˆLOW/MEDIUM é£é™©ï¼‰

**ç»“æ„**ï¼š
```
ã€ç³»ç»Ÿè§’è‰²ã€‘
ä½ æ˜¯ Wavecho çš„æƒ…æ„Ÿå…³ç³»åˆ†æåŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·å®¢è§‚ã€æ¸©å’Œåœ°å¤ç›˜å¯¹è¯å†²çªã€‚

ã€è¾“å…¥ã€‘
- èŠå¤©è®°å½•ï¼š{conversation_text}
- èƒŒæ™¯æè¿°ï¼š{context_description}

ã€ä»»åŠ¡ã€‘
1. æ¢³ç†äº‹ä»¶æ—¶é—´çº¿ï¼ˆ3-5 ä¸ªå…³é”®è½¬æŠ˜ç‚¹ï¼‰
2. åˆ†æåŒæ–¹æƒ…ç»ªå˜åŒ–ï¼ˆä¸»è¦æƒ…ç»ª + æ¬¡è¦æƒ…ç»ªï¼‰
3. è¯†åˆ«åŒæ–¹çœŸå®éœ€æ±‚ï¼ˆè€Œéè¡¨é¢è¯‰æ±‚ï¼‰
4. æ€»ç»“æ ¸å¿ƒçŸ›ç›¾
5. ç”Ÿæˆ 2-3 æ¡æ²Ÿé€šå»ºè®®æ¶ˆæ¯æ¨¡æ¿ï¼ˆæ¸©å’Œã€å¯æ‰§è¡Œï¼‰

ã€è¾“å‡ºæ ¼å¼ã€‘
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ï¼ˆä¸è¦åŒ…å«ä»»ä½•é¢å¤–æ–‡å­—ï¼‰ï¼š
{
  "summary": "...",
  "timeline": [...],
  "emotionAnalysis": {...},
  "needsAnalysis": {...},
  "advice": [...]
}

ã€åŸåˆ™ã€‘
- ä¿æŒä¸­ç«‹ï¼Œä¸åè¢’ä»»ä½•ä¸€æ–¹
- è¯­æ°”æ¸©å’Œã€å°Šé‡ï¼Œé¿å…æŒ‡è´£
- å»ºè®®å…·ä½“å¯æ“ä½œï¼Œä¸ç©ºæ´
```

#### 5.3.2 è°¨æ…æ¨¡å¼ Promptï¼ˆHIGH é£é™©ï¼‰

**è°ƒæ•´**ï¼š
- å¢åŠ ï¼š"æ³¨æ„ï¼šå¯¹è¯ä¸­åŒ…å«è¾ƒå¼ºè´Ÿé¢æƒ…ç»ªï¼Œè¯·åœ¨å»ºè®®ä¸­ä¼˜å…ˆå…³æ³¨æƒ…ç»ªå®‰æŠšï¼Œé¿å…æ¿€è¿›å»ºè®®"
- å»ºè®®ç±»å‹è°ƒæ•´ä¸ºï¼š"æƒ…ç»ªæ”¯æŒå‹"ã€"å¯»æ±‚å¤–éƒ¨å¸®åŠ©å‹"

#### 5.3.3 é«˜é£é™©å®‰å…¨æ¨¡å¼ Promptï¼ˆCRITICAL é£é™©ï¼‰

**è°ƒæ•´**ï¼š
- ç§»é™¤"ç”Ÿæˆå’Œè§£æ¶ˆæ¯"ä»»åŠ¡
- ä»»åŠ¡æ”¹ä¸ºï¼š"è¯†åˆ«æƒ…ç»ªå±æœºä¿¡å· + æä¾›ä¸“ä¸šæ±‚åŠ©å¼•å¯¼"
- è¾“å‡ºæ ¼å¼ç®€åŒ–ï¼š
```json
{
  "summary": "å¯¹è¯ä¸­åŒ…å«ä¸¥é‡æƒ…ç»ªå±æœºä¿¡å·",
  "riskHints": [
    "å¦‚æœæ‚¨æˆ–å¯¹æ–¹æ­£åœ¨ç»å†ä¸¥é‡æƒ…ç»ªå›°æ‰°ï¼Œè¯·ç«‹å³å¯»æ±‚ä¸“ä¸šå¸®åŠ©ï¼š",
    "å¿ƒç†æ´åŠ©çƒ­çº¿ï¼š...",
    "ç´§æ€¥æƒ…å†µè¯·æ‹¨æ‰“ 110 æˆ–è”ç³»å®¶äººæœ‹å‹"
  ],
  "advice": []  // ä¸æä¾›å…·ä½“å»ºè®®
}
```

### 5.4 æ•°æ®åŠ å¯†ä¸éšç§ä¿æŠ¤

#### 5.4.1 æ•æ„Ÿå­—æ®µåŠ å¯†

**éœ€åŠ å¯†å­—æ®µ**ï¼š
- `conversationText`ï¼ˆåŸå§‹èŠå¤©è®°å½•ï¼‰
- `contextDescription`ï¼ˆèƒŒæ™¯æè¿°ï¼‰

**åŠ å¯†æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ AES-256-GCM å¯¹ç§°åŠ å¯†
- å¯†é’¥ç®¡ç†ï¼šå­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ `ENCRYPTION_KEY`ï¼ˆ32 å­—èŠ‚éšæœºå¯†é’¥ï¼‰
- åŠ å¯†åå­˜å‚¨ä¸º Base64 å­—ç¬¦ä¸²

**å®ç°ä½ç½®**ï¼š
- `app/core/security.py` æä¾› `encrypt()` å’Œ `decrypt()` å‡½æ•°
- åœ¨ `Orchestrator` å†™å…¥æ•°æ®åº“å‰åŠ å¯†ï¼Œè¯»å–æ—¶è§£å¯†

#### 5.4.2 æ—¥å¿—è„±æ•

**è§„åˆ™**ï¼š
- âœ… å¯è®°å½•ï¼š`sessionId`, `userId`, `riskLevel`, `status`, æ—¶é—´æˆ³
- âŒ ä¸å¯è®°å½•ï¼š`conversationText`, `contextDescription`, åˆ†æç»“æœä¸­çš„å…·ä½“æ–‡æœ¬

**ç¤ºä¾‹**ï¼š
```python
# âœ… æ­£ç¡®
logger.info(f"Session {session_id} analysis completed, risk={risk_level}")

# âŒ é”™è¯¯
logger.info(f"User input: {conversation_text}")
```

---

## 6. æ•°æ®æ¨¡å‹ä¸å­˜å‚¨è®¾è®¡

### 6.1 æ•°æ®åº“é€‰å‹ï¼šMongoDB

**ç†ç”±æ¦‚è¿°**ï¼ˆè§ç¬¬ 3 ç« è¯¦ç»†è¯´æ˜ï¼‰ï¼š
- éç»“æ„åŒ–æ–‡æœ¬å­˜å‚¨æ›´è‡ªç„¶
- åˆ†æç»“æœ JSON çµæ´»æ‰©å±•
- å•æ–‡æ¡£æ“ä½œä¸ºä¸»ï¼Œæ— å¤æ‚ JOIN
- æ˜“äºæ¨ªå‘æ‰©å±•

### 6.2 Collection è®¾è®¡

#### 6.2.1 users é›†åˆï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰

**Schema**:
```javascript
{
  _id: ObjectId,
  userId: String (UUID, unique, indexed),
  email: String (unique, indexed),
  emailVerified: Boolean,
  isAnonymous: Boolean,
  passwordHash: String (å¦‚æœæ”¯æŒå¯†ç ç™»å½•ï¼ŒMVP å¯çœç•¥),
  createdAt: ISODate,
  updatedAt: ISODate,
  lastLoginAt: ISODate,
  metadata: {
    appVersion: String,
    platform: "iOS | Android"
  }
}
```

**ç´¢å¼•**:
```javascript
db.users.createIndex({ userId: 1 }, { unique: true })
db.users.createIndex({ email: 1 }, { unique: true, sparse: true })
db.users.createIndex({ createdAt: -1 })
```

**å­—æ®µè¯´æ˜**:
- `isAnonymous`: true è¡¨ç¤ºåŒ¿åç”¨æˆ·ï¼ˆUUID ä½œä¸º userIdï¼Œæ—  emailï¼‰
- `email`: ä»…åœ¨é‚®ç®±ç™»å½•æ—¶å­˜åœ¨
- `passwordHash`: MVP é˜¶æ®µä½¿ç”¨éªŒè¯ç ç™»å½•ï¼Œå¯æš‚ä¸å­˜å‚¨å¯†ç 

#### 6.2.2 analysis_sessions é›†åˆï¼ˆåˆ†æä¼šè¯ï¼‰

**Schema**:
```javascript
{
  _id: ObjectId,
  sessionId: String (UUID, unique, indexed),
  userId: String (indexed),
  status: String ("processing" | "completed" | "failed"),
  
  // è¾“å…¥æ•°æ®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  input: {
    conversationTextEncrypted: String (Base64),
    contextDescriptionEncrypted: String (Base64),
    originalLength: Number (åŸå§‹æ–‡æœ¬é•¿åº¦ï¼Œç”¨äºç»Ÿè®¡)
  },
  
  // é£é™©åˆ†ç±»ç»“æœ
  riskClassification: {
    riskLevel: String ("LOW" | "MEDIUM" | "HIGH" | "CRITICAL"),
    tags: [String],
    confidence: Number
  },
  
  // åˆ†æç»“æœï¼ˆä¸åŠ å¯†ï¼Œä½†è„±æ•ï¼‰
  analysisResult: {
    summary: String,
    timeline: [
      {
        step: Number,
        description: String,
        emotion: String,
        speaker: String ("æˆ‘" | "å¯¹æ–¹")
      }
    ],
    emotionAnalysis: {
      myEmotions: {
        primary: String,
        secondary: [String],
        explanation: String
      },
      theirEmotions: {
        primary: String,
        secondary: [String],
        explanation: String
      }
    },
    needsAnalysis: {
      myNeeds: [String],
      theirNeeds: [String],
      conflictCore: String
    },
    advice: [
      {
        type: String ("gentle" | "explanatory" | "humorous"),
        title: String,
        message: String,
        explanation: String
      }
    ],
    riskHints: [String]
  },
  
  // å…ƒæ•°æ®
  llmMetadata: {
    model: String ("gpt-4", "gpt-3.5-turbo"),
    promptTokens: Number,
    completionTokens: Number,
    latencyMs: Number
  },
  
  createdAt: ISODate,
  completedAt: ISODate,
  errorMessage: String (ä»… status=failed æ—¶å­˜åœ¨)
}
```

**ç´¢å¼•**:
```javascript
db.analysis_sessions.createIndex({ sessionId: 1 }, { unique: true })
db.analysis_sessions.createIndex({ userId: 1, createdAt: -1 })
db.analysis_sessions.createIndex({ status: 1 })
db.analysis_sessions.createIndex({ "riskClassification.riskLevel": 1 })
```

**å­—æ®µè¯´æ˜**:
- `input.conversationTextEncrypted`: åŠ å¯†åçš„èŠå¤©è®°å½•ï¼ˆAES-256-GCMï¼‰
- `analysisResult`: LLM è¿”å›çš„ç»“æ„åŒ–ç»“æœï¼Œä¸åŠ å¯†ä½†ä¸åŒ…å«åŸå§‹å¯¹è¯
- `llmMetadata`: ç”¨äºæˆæœ¬ç»Ÿè®¡å’Œæ€§èƒ½ç›‘æ§
- TTL ç­–ç•¥ï¼ˆå¯é€‰ï¼‰ï¼š90 å¤©åè‡ªåŠ¨åˆ é™¤ï¼ˆéšç§ä¿æŠ¤ï¼‰

#### 6.2.3 verification_codes é›†åˆï¼ˆéªŒè¯ç ï¼ŒMVP å¿…éœ€ï¼‰

**Schema**:
```javascript
{
  _id: ObjectId,
  email: String (indexed),
  code: String (6 ä½æ•°å­—),
  expiresAt: ISODate,
  used: Boolean,
  createdAt: ISODate
}
```

**ç´¢å¼•**:
```javascript
db.verification_codes.createIndex({ email: 1, createdAt: -1 })
db.verification_codes.createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 })
```

**TTL ç­–ç•¥**:
- è‡ªåŠ¨è¿‡æœŸï¼š5 åˆ†é’Ÿåè‡ªåŠ¨åˆ é™¤ï¼ˆMongoDB TTL Indexï¼‰

#### 6.2.4 audit_logs é›†åˆï¼ˆå®¡è®¡æ—¥å¿—ï¼ŒP1 å¯é€‰ï¼‰

**Schema**:
```javascript
{
  _id: ObjectId,
  sessionId: String (indexed),
  userId: String (indexed),
  eventType: String ("analyze_started" | "risk_detected" | "analysis_completed" | "guard_rejected"),
  riskLevel: String,
  guardIssues: [String],  // å¦‚æœå®‰å…¨å®¡æŸ¥å¤±è´¥ï¼Œè®°å½•åŸå› 
  timestamp: ISODate
}
```

**ç”¨é€”**ï¼š
- ç›‘æ§é«˜é£é™©ä¼šè¯é¢‘ç‡
- åˆ†æ ResponseGuard æ‹¦æˆªæ•ˆæœ
- åˆè§„å®¡è®¡ï¼ˆå¦‚éœ€è¦ï¼‰

### 6.3 æ•æ„Ÿæ•°æ®å¤„ç†ç­–ç•¥

#### 6.3.1 åŠ å¯†å­˜å‚¨

**åŠ å¯†å­—æ®µ**ï¼š
- `conversationTextEncrypted`
- `contextDescriptionEncrypted`

**åŠ å¯†æµç¨‹**ï¼š
1. Orchestrator æ¥æ”¶åŸå§‹æ–‡æœ¬
2. è°ƒç”¨ `security.encrypt(text, key=ENCRYPTION_KEY)`
3. è¿”å› Base64 ç¼–ç çš„å¯†æ–‡
4. å­˜å‚¨åˆ° MongoDB

**è§£å¯†æµç¨‹**ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼ŒMVP é˜¶æ®µä¸éœ€è¦ï¼‰ï¼š
1. ä» MongoDB è¯»å–å¯†æ–‡
2. è°ƒç”¨ `security.decrypt(ciphertext, key=ENCRYPTION_KEY)`
3. è¿”å›æ˜æ–‡

**å¯†é’¥ç®¡ç†**ï¼š
- å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ `.env` ä¸­
- å¯†é’¥è½®æ¢ç­–ç•¥ï¼šV2 åŠŸèƒ½ï¼ˆä½¿ç”¨å¯†é’¥ç‰ˆæœ¬å·å­—æ®µï¼‰

#### 6.3.2 æ•°æ®è„±æ•

**åˆ†æç»“æœè„±æ•åŸåˆ™**ï¼š
- âœ… ä¿ç•™ï¼šæƒ…ç»ªè¯ã€éœ€æ±‚è¯ã€æ—¶é—´çº¿æè¿°ï¼ˆæŠ½è±¡åŒ–ï¼‰
- âŒ ç§»é™¤ï¼šå…·ä½“å¯¹è¯åŸæ–‡ã€äººåã€åœ°ç‚¹ã€æ•æ„Ÿç»†èŠ‚

**LLM Prompt ä¸­è¦æ±‚**ï¼š
- "åœ¨æ—¶é—´çº¿å’Œå»ºè®®ä¸­ï¼Œä¸è¦ç›´æ¥å¼•ç”¨åŸæ–‡ï¼Œè€Œæ˜¯ç”¨æŠ½è±¡æè¿°"
- ç¤ºä¾‹ï¼š
  - âŒ "å¯¹æ–¹è¯´ï¼š'ä½ å°±æ˜¯ä¸ªæ··è›‹'"
  - âœ… "å¯¹æ–¹ä½¿ç”¨äº†æ¿€çƒˆçš„æŒ‡è´£æ€§è¯­è¨€"

#### 6.3.3 ç”¨æˆ·æ•°æ®åˆ é™¤

**ç”¨æˆ·è¯·æ±‚åˆ é™¤è´¦å·æ—¶**ï¼ˆV2 åŠŸèƒ½ï¼ŒMVP è®¾è®¡é¢„ç•™ï¼‰ï¼š
1. åˆ é™¤ `users` é›†åˆä¸­çš„è®°å½•
2. åˆ é™¤ `analysis_sessions` ä¸­è¯¥ userId çš„æ‰€æœ‰è®°å½•
3. åˆ é™¤ `verification_codes` ä¸­çš„éªŒè¯ç è®°å½•
4. è®°å½•åˆ é™¤æ“ä½œåˆ° `audit_logs`

**ç¡¬åˆ é™¤ vs è½¯åˆ é™¤**ï¼š
- MVP é‡‡ç”¨**ç¡¬åˆ é™¤**ï¼ˆç›´æ¥ `deleteMany()`ï¼‰
- V2 å¯æ”¹ä¸ºè½¯åˆ é™¤ï¼ˆå¢åŠ  `deleted: true` å­—æ®µï¼Œä¿ç•™ 30 å¤©åç‰©ç†åˆ é™¤ï¼‰

### 6.4 æ•°æ®åº“è¿æ¥ä¸æ“ä½œå°è£…

**è¿æ¥ç®¡ç†** (`app/db/mongodb.py`):
```python
# ä¼ªä»£ç ç¤ºä¾‹ç»“æ„
from motor.motor_asyncio import AsyncIOMotorClient

class MongoDB:
    client: AsyncIOMotorClient = None
    db = None
    
    @classmethod
    async def connect(cls):
        cls.client = AsyncIOMotorClient(MONGO_URI)
        cls.db = cls.client[DB_NAME]
    
    @classmethod
    async def close(cls):
        cls.client.close()
    
    @classmethod
    def get_collection(cls, name: str):
        return cls.db[name]
```

**CRUD æ“ä½œå°è£…**ï¼ˆRepository æ¨¡å¼ï¼‰:
- `UserRepository`: ç”¨æˆ·å¢åˆ æ”¹æŸ¥
- `AnalysisRepository`: ä¼šè¯å¢åˆ æ”¹æŸ¥
- æä¾›ç±»å‹å®‰å…¨çš„æ–¹æ³•ï¼Œé¿å…ç›´æ¥æ“ä½œåŸç”Ÿ MongoDB API

---

## 7. å¤§æ¨¡å‹äº¤äº’è®¾è®¡

### 7.1 LLM Provider é€‰å‹

**MVP é˜¶æ®µæ¨è**ï¼š
- **ä¸»é€‰æ–¹æ¡ˆ**ï¼šOpenAI GPT-4 Turboï¼ˆ`gpt-4-turbo-preview`ï¼‰
  - ç†ç”±ï¼šç†è§£åŠ›å¼ºï¼Œç»“æ„åŒ–è¾“å‡ºç¨³å®šï¼ŒJSON æ ¼å¼å‡†ç¡®ç‡é«˜
  - æˆæœ¬ï¼šçº¦ $0.01/æ¬¡åˆ†æï¼ˆé¢„ä¼° 1500 tokensï¼‰
- **å¤‡é€‰æ–¹æ¡ˆ**ï¼šGPT-3.5 Turboï¼ˆé™çº§æ–¹æ¡ˆï¼Œæˆæœ¬ä½ä½†è´¨é‡ç•¥å·®ï¼‰

**V2 æ‰©å±•**ï¼š
- æ”¯æŒå›½å†…å¤§æ¨¡å‹ï¼ˆæ™ºè°± GLM-4ã€é€šä¹‰åƒé—®ã€æ–‡å¿ƒä¸€è¨€ç­‰ï¼‰
- é€šè¿‡é…ç½®æ–‡ä»¶åˆ‡æ¢ Provider

### 7.2 Prompt å·¥ç¨‹è®¾è®¡

#### 7.2.1 Prompt ç»“æ„è§„èŒƒ

**é€šç”¨ç»“æ„**ï¼ˆåˆ†ä¸º 4 ä¸ªéƒ¨åˆ†ï¼‰ï¼š

```
# Part 1: System Roleï¼ˆç³»ç»Ÿè§’è‰²ï¼‰
å®šä¹‰ AI çš„èº«ä»½ã€èƒ½åŠ›è¾¹ç•Œã€è¯­æ°”é£æ ¼

# Part 2: Task Descriptionï¼ˆä»»åŠ¡æè¿°ï¼‰
æ˜ç¡®å…·ä½“è¦åšä»€ä¹ˆï¼ŒåŒ…å«è¾“å…¥æ ¼å¼è¯´æ˜

# Part 3: Output Formatï¼ˆè¾“å‡ºæ ¼å¼ï¼‰
ä¸¥æ ¼å®šä¹‰ JSON Schemaï¼ŒåŒ…å«ç¤ºä¾‹

# Part 4: Principles & Constraintsï¼ˆåŸåˆ™ä¸çº¦æŸï¼‰
å®‰å…¨è§„åˆ™ã€ç¦æ­¢äº‹é¡¹ã€è¯­æ°”è¦æ±‚
```

#### 7.2.2 æ ‡å‡†æ¨¡å¼ Prompt è¯¦ç»†ç‰ˆ

**å®Œæ•´ Prompt æ¨¡æ¿** (`app/prompts/standard.py`):

```python
STANDARD_PROMPT_TEMPLATE = """
# Part 1: ç³»ç»Ÿè§’è‰²
ä½ æ˜¯ Wavecho çš„æƒ…æ„Ÿå…³ç³»åˆ†æåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä»¥ç¬¬ä¸‰æ–¹è§†è§’ï¼Œå®¢è§‚ã€æ¸©å’Œåœ°å¸®åŠ©ç”¨æˆ·å¤ç›˜å¯¹è¯å†²çªï¼Œç†è§£åŒæ–¹æƒ…ç»ªä¸éœ€æ±‚ï¼Œæä¾›å»ºè®¾æ€§çš„æ²Ÿé€šå»ºè®®ã€‚

ä½ ä¸æ˜¯å¿ƒç†å’¨è¯¢å¸ˆï¼Œä¸æä¾›å¿ƒç†è¯Šæ–­ã€‚ä½ æ˜¯ä¸€ä¸ª"æ²Ÿé€šç¿»è¯‘å®˜"å’Œ"å†·é™å‰‚"ã€‚

# Part 2: ä»»åŠ¡æè¿°
ç”¨æˆ·æä¾›äº†ä¸€æ®µå‘ç”Ÿå†²çªçš„èŠå¤©è®°å½•å’ŒèƒŒæ™¯æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ä½ éœ€è¦ï¼š

1. **æ¢³ç†äº‹ä»¶æ—¶é—´çº¿**ï¼šæç‚¼ 3-5 ä¸ªå…³é”®è½¬æŠ˜ç‚¹ï¼Œè¯´æ˜å†²çªå¦‚ä½•é€æ­¥å‡çº§
2. **åˆ†æåŒæ–¹æƒ…ç»ª**ï¼šè¯†åˆ«"æˆ‘"ï¼ˆç”¨æˆ·ï¼‰å’Œ"å¯¹æ–¹"çš„ä¸»è¦æƒ…ç»ªå’Œæ¬¡è¦æƒ…ç»ª
3. **è¯†åˆ«çœŸå®éœ€æ±‚**ï¼šæŒ–æ˜è¡¨é¢è¯‰æ±‚èƒŒåçš„æ·±å±‚éœ€æ±‚ï¼ˆå¦‚"è¢«ç†è§£""å®‰å…¨æ„Ÿ""å°Šé‡"ï¼‰
4. **æ€»ç»“æ ¸å¿ƒçŸ›ç›¾**ï¼šç”¨ä¸€å¥è¯æ¦‚æ‹¬å†²çªçš„æ ¹æœ¬åŸå› 
5. **ç”Ÿæˆæ²Ÿé€šå»ºè®®**ï¼šæä¾› 2-3 æ¡å…·ä½“å¯å‘é€çš„æ¶ˆæ¯æ¨¡æ¿ï¼Œå¸®åŠ©ç”¨æˆ·å’Œè§£

## è¾“å…¥å†…å®¹
ã€èŠå¤©è®°å½•ã€‘
{conversation_text}

ã€èƒŒæ™¯æè¿°ã€‘
{context_description}

# Part 3: è¾“å‡ºæ ¼å¼
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ï¼Œä¸è¦åŒ…å«ä»»ä½•ä»£ç å—æ ‡è®°æˆ–é¢å¤–æ–‡å­—ï¼š

{{
  "summary": "string (50-100 å­—ï¼Œç®€çŸ­æ€»ç»“å†²çª)",
  "timeline": [
    {{
      "step": 1,
      "description": "string (è¿™ä¸€æ­¥å‘ç”Ÿäº†ä»€ä¹ˆ)",
      "emotion": "string (ä¸»å¯¼æƒ…ç»ª)",
      "speaker": "æˆ‘" | "å¯¹æ–¹"
    }}
  ],
  "emotionAnalysis": {{
    "myEmotions": {{
      "primary": "string (ä¸»è¦æƒ…ç»ªï¼Œå¦‚'ç„¦è™‘')",
      "secondary": ["string"],
      "explanation": "string (ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§æƒ…ç»ª)"
    }},
    "theirEmotions": {{
      "primary": "string",
      "secondary": ["string"],
      "explanation": "string"
    }}
  }},
  "needsAnalysis": {{
    "myNeeds": ["string"],
    "theirNeeds": ["string"],
    "conflictCore": "string (æ ¸å¿ƒçŸ›ç›¾)"
  }},
  "advice": [
    {{
      "type": "gentle",
      "title": "æ¸©å’Œé“æ­‰ç‰ˆ",
      "message": "string (å®Œæ•´çš„æ¶ˆæ¯æ–‡æœ¬ï¼Œ50-150 å­—)",
      "explanation": "string (ä¸ºä»€ä¹ˆè¿™æ ·è¯´æœ‰æ•ˆ)"
    }},
    {{
      "type": "explanatory",
      "title": "è§£é‡Šç‰ˆ",
      "message": "string",
      "explanation": "string"
    }}
  ]
}}

# Part 4: åŸåˆ™ä¸çº¦æŸ
1. **ä¿æŒä¸­ç«‹**ï¼šä¸åè¢’ä»»ä½•ä¸€æ–¹ï¼Œä¸åšé“å¾·è¯„åˆ¤
2. **è¯­æ°”æ¸©å’Œ**ï¼šé¿å…"ä½ é”™äº†""å¯¹æ–¹ä¸å¯¹"ç­‰æŒ‡è´£æ€§è¡¨è¿°
3. **å…·ä½“å¯æ“ä½œ**ï¼šå»ºè®®æ¶ˆæ¯è¦å®Œæ•´ã€è‡ªç„¶ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶å‘é€
4. **å°Šé‡éšç§**ï¼šä¸åœ¨è¾“å‡ºä¸­æ³„éœ²å…·ä½“å§“åã€åœ°ç‚¹ç­‰æ•æ„Ÿä¿¡æ¯
5. **é¿å…æç«¯å»ºè®®**ï¼šä¸å»ºè®®"ç«‹åˆ»åˆ†æ‰‹""æ–­ç»å…³ç³»"ç­‰ä¸å¯é€†å†³ç­–
6. **å®‰å…¨ç¬¬ä¸€**ï¼šå¦‚æœå¯¹è¯æ¶‰åŠæš´åŠ›ã€è‡ªæ®‹ï¼Œä¼˜å…ˆå…³æ³¨æƒ…ç»ªå®‰æŠš
"""
```

**Prompt å˜é‡æ›¿æ¢**ï¼š
```python
prompt = STANDARD_PROMPT_TEMPLATE.format(
    conversation_text=user_input.conversation_text,
    context_description=user_input.context_description or "æ— "
)
```

#### 7.2.3 é«˜é£é™©å®‰å…¨æ¨¡å¼ Prompt

**å…³é”®è°ƒæ•´**ï¼š
- ç§»é™¤"ç”Ÿæˆå’Œè§£æ¶ˆæ¯"ä»»åŠ¡
- å¢åŠ "è¯†åˆ«å±æœºä¿¡å·"ä»»åŠ¡
- è¾“å‡ºç®€åŒ–ä¸ºé£é™©æç¤º + æ±‚åŠ©å¼•å¯¼

**Prompt ç‰‡æ®µ** (`app/prompts/high_risk.py`):
```python
HIGH_RISK_PROMPT_TEMPLATE = """
# æ³¨æ„ï¼šè¾“å…¥æ–‡æœ¬åŒ…å«ä¸¥é‡æƒ…ç»ªå±æœºä¿¡å·

ä½ çš„ä»»åŠ¡å˜æ›´ä¸ºï¼š
1. è¯†åˆ«å…·ä½“çš„å±æœºä¿¡å·ï¼ˆè‡ªæ®‹ã€è‡ªæ€ã€ä¸¥é‡æš´åŠ›å€¾å‘ï¼‰
2. æä¾›æƒ…ç»ªæ”¯æŒæ€§çš„ç®€çŸ­æ€»ç»“
3. **ä¸ç”Ÿæˆå’Œè§£æ¶ˆæ¯**ï¼Œè€Œæ˜¯å¼•å¯¼ç”¨æˆ·å¯»æ±‚ä¸“ä¸šå¸®åŠ©

è¾“å‡ºæ ¼å¼ï¼š
{{
  "summary": "å¯¹è¯ä¸­åŒ…å«ä¸¥é‡æƒ…ç»ªå›°æ‰°ä¿¡å·ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šæ”¯æŒ",
  "riskHints": [
    "å¦‚æœæ‚¨æˆ–å¯¹æ–¹æ­£åœ¨ç»å†ä¸¥é‡çš„æƒ…ç»ªå±æœºï¼Œè¯·è€ƒè™‘ï¼š",
    "â€¢ å¿ƒç†æ´åŠ©çƒ­çº¿ï¼šBeijing Suicide Research and Prevention Center 010-82951332",
    "â€¢ ç´§æ€¥æƒ…å†µè¯·æ‹¨æ‰“ 110 æˆ–è”ç³»ä¿¡ä»»çš„å®¶äººæœ‹å‹",
    "â€¢ å¯»æ‰¾ä¸“ä¸šå¿ƒç†å’¨è¯¢å¸ˆï¼ˆæ¨èå¹³å°ï¼šç®€å•å¿ƒç†ã€å£¹å¿ƒç†ï¼‰"
  ],
  "advice": []
}}

åŸåˆ™ï¼š
- ä¸é¼“åŠ±ä»»ä½•è‡ªæ®‹/è‡ªæ€è¡Œä¸º
- ä¸æä¾›"å¦‚ä½•å’Œè§£"çš„å…·ä½“å»ºè®®ï¼ˆå¯èƒ½åŠ å‰§å¿ƒç†è´Ÿæ‹…ï¼‰
- è¯­æ°”å…³æ€€ä½†ä¸ä¾µå…¥
"""
```

### 7.3 LLM è°ƒç”¨å‚æ•°é…ç½®

**æ¨èå‚æ•°**ï¼ˆé’ˆå¯¹ OpenAI APIï¼‰:

| å‚æ•° | å€¼ | ç†ç”± |
|------|-----|------|
| `model` | `gpt-4-turbo-preview` | å¹³è¡¡æ€§èƒ½ä¸æˆæœ¬ |
| `temperature` | `0.7` | é€‚åº¦åˆ›é€ æ€§ï¼Œä½†ä¸è¿‡åº¦å‘æ•£ |
| `max_tokens` | `2000` | è¶³å¤Ÿè¾“å‡ºå®Œæ•´ JSONï¼Œé¿å…æˆªæ–­ |
| `top_p` | `0.9` | ä¿æŒè¾“å‡ºç¨³å®šæ€§ |
| `response_format` | `{"type": "json_object"}` | å¼ºåˆ¶ JSON è¾“å‡ºï¼ˆGPT-4 Turbo æ”¯æŒï¼‰ |

**è¯·æ±‚ç¤ºä¾‹**ï¼ˆä¼ªä»£ç ï¼‰:
```python
async def generate(self, prompt: str) -> str:
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.post(
            "https://api.openai.com/v1/chat/completions",
            headers={"Authorization": f"Bearer {OPENAI_API_KEY}"},
            json={
                "model": "gpt-4-turbo-preview",
                "messages": [
                    {"role": "system", "content": "You are a helpful assistant."},
                    {"role": "user", "content": prompt}
                ],
                "temperature": 0.7,
                "max_tokens": 2000,
                "response_format": {"type": "json_object"}
            }
        )
        result = response.json()
        return result["choices"][0]["message"]["content"]
```

### 7.4 è¶…æ—¶ä¸é‡è¯•ç­–ç•¥

#### 7.4.1 è¶…æ—¶è®¾ç½®

| é˜¶æ®µ | è¶…æ—¶æ—¶é—´ | å¤„ç† |
|------|---------|------|
| **å•æ¬¡ LLM è¯·æ±‚** | 30 ç§’ | æŠ›å‡º `LLMTimeoutError` |
| **æ•´ä¸ªåˆ†ææµç¨‹** | 60 ç§’ | è¿”å›é™çº§å“åº” |

#### 7.4.2 é‡è¯•ç­–ç•¥

**è§¦å‘é‡è¯•çš„é”™è¯¯ç **ï¼š
- `429`ï¼šRate Limitï¼ˆç­‰å¾… 2 ç§’åé‡è¯•ï¼‰
- `503`ï¼šService Unavailableï¼ˆç­‰å¾… 5 ç§’åé‡è¯•ï¼‰
- ç½‘ç»œè¶…æ—¶ï¼ˆç«‹å³é‡è¯• 1 æ¬¡ï¼‰

**ä¸é‡è¯•çš„é”™è¯¯ç **ï¼š
- `400`ï¼šBad Requestï¼ˆPrompt æ ¼å¼é”™è¯¯ï¼Œè®°å½•æ—¥å¿—ï¼‰
- `401`ï¼šUnauthorizedï¼ˆAPI Key é”™è¯¯ï¼Œç«‹å³å¤±è´¥ï¼‰
- `500`ï¼šInternal Server Errorï¼ˆLLM æœåŠ¡ç«¯é”™è¯¯ï¼Œè®°å½•åé™çº§ï¼‰

**é‡è¯•æ¬¡æ•°**ï¼šæœ€å¤š 2 æ¬¡ï¼ˆå…± 3 æ¬¡å°è¯•ï¼‰

**å®ç°æ–¹å¼**ï¼ˆä½¿ç”¨ `tenacity` åº“ï¼‰:
```python
from tenacity import retry, stop_after_attempt, wait_fixed, retry_if_exception_type

@retry(
    stop=stop_after_attempt(3),
    wait=wait_fixed(2),
    retry=retry_if_exception_type((httpx.TimeoutException, RateLimitError))
)
async def generate_with_retry(self, prompt: str) -> str:
    return await self._generate(prompt)
```

### 7.5 LLM è¾“å‡ºè§£æä¸å®¹é”™

#### 7.5.1 JSON è§£æ

**æ­¥éª¤**ï¼š
1. å»é™¤å¯èƒ½çš„ Markdown ä»£ç å—æ ‡è®°ï¼ˆ```json ... ```ï¼‰
2. ä½¿ç”¨ `json.loads()` è§£æ
3. éªŒè¯å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨

**å®¹é”™å¤„ç†**ï¼š
- å¦‚æœç¼ºå°‘æŸäº›å­—æ®µï¼ˆå¦‚ `advice`ï¼‰ï¼Œå¡«å……é»˜è®¤å€¼
- å¦‚æœæ•´ä½“æ ¼å¼é”™è¯¯ï¼Œè®°å½•åŸå§‹è¾“å‡ºå¹¶è¿”å›é™çº§å“åº”

**ç¤ºä¾‹ä»£ç **ï¼ˆä¼ªä»£ç ï¼‰:
```python
def parse_llm_response(raw_text: str) -> dict:
    # å»é™¤ä»£ç å—æ ‡è®°
    text = raw_text.strip()
    if text.startswith("```json"):
        text = text[7:]
    if text.endswith("```"):
        text = text[:-3]
    
    # è§£æ JSON
    try:
        data = json.loads(text)
    except json.JSONDecodeError as e:
        logger.error(f"LLM output JSON parse failed: {e}, raw: {raw_text[:200]}")
        raise LLMOutputError("Invalid JSON format")
    
    # éªŒè¯å¿…éœ€å­—æ®µ
    required_fields = ["summary", "timeline", "emotionAnalysis", "needsAnalysis", "advice"]
    for field in required_fields:
        if field not in data:
            logger.warning(f"Missing field: {field}")
            data[field] = get_default_value(field)
    
    return data
```

#### 7.5.2 é™çº§å“åº”ç­–ç•¥

**è§¦å‘æ¡ä»¶**ï¼š
- LLM è¶…æ—¶ 3 æ¬¡ä»å¤±è´¥
- LLM è¿”å›æ— æ³•è§£æçš„è¾“å‡º
- ResponseGuard å¤šæ¬¡æ‹¦æˆªåä»ä¸å®‰å…¨

**é™çº§å“åº”å†…å®¹**ï¼š
```json
{
  "summary": "æŠ±æ­‰ï¼Œå½“å‰åˆ†æé‡åˆ°æŠ€æœ¯é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•",
  "timeline": [],
  "emotionAnalysis": {
    "myEmotions": { "primary": "å¤æ‚æƒ…ç»ª", "secondary": [], "explanation": "ç³»ç»Ÿæš‚æ—¶æ— æ³•åˆ†æ" },
    "theirEmotions": { "primary": "å¤æ‚æƒ…ç»ª", "secondary": [], "explanation": "ç³»ç»Ÿæš‚æ—¶æ— æ³•åˆ†æ" }
  },
  "needsAnalysis": {
    "myNeeds": [],
    "theirNeeds": [],
    "conflictCore": "æš‚æ—¶æ— æ³•è¯†åˆ«"
  },
  "advice": [
    {
      "type": "fallback",
      "title": "å»ºè®®",
      "message": "å½“å‰æƒ…å†µè¾ƒä¸ºå¤æ‚ï¼Œå»ºè®®æ‚¨å†·é™æ€è€ƒåï¼Œé€‰æ‹©åˆé€‚çš„æ—¶æœºä¸å¯¹æ–¹æ²Ÿé€šã€‚å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å¯»æ±‚ä¸“ä¸šäººå£«å¸®åŠ©ã€‚",
      "explanation": ""
    }
  ]
}
```

### 7.6 æˆæœ¬æ§åˆ¶ä¸ç›‘æ§

#### 7.6.1 Token è®¡æ•°ä¸é¢„ä¼°

**Token é¢„ä¼°**ï¼ˆé’ˆå¯¹ GPT-4ï¼‰:
- è¾“å…¥ Promptï¼š~800 tokensï¼ˆæ¨¡æ¿ï¼‰ + ç”¨æˆ·è¾“å…¥é•¿åº¦
- è¾“å‡ºï¼š~700 tokensï¼ˆç»“æ„åŒ– JSONï¼‰
- å•æ¬¡åˆ†ææ€»è®¡ï¼š~1500 tokens
- æˆæœ¬ï¼š$0.01/æ¬¡ï¼ˆGPT-4 Turbo ä»·æ ¼ï¼š$0.01/1K tokens è¾“å…¥ + $0.03/1K tokens è¾“å‡ºï¼‰

**æ¯æ—¥æˆæœ¬é¢„ä¼°**ï¼š
- 100 æ¬¡åˆ†æ/å¤©ï¼š$1
- 1000 æ¬¡åˆ†æ/å¤©ï¼š$10

#### 7.6.2 ç›‘æ§æŒ‡æ ‡

**è®°å½•åˆ° `llmMetadata` å­—æ®µ**ï¼š
- `model`: ä½¿ç”¨çš„æ¨¡å‹åç§°
- `promptTokens`: è¾“å…¥ Token æ•°
- `completionTokens`: è¾“å‡º Token æ•°
- `latencyMs`: è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰

**å®šæœŸç»Ÿè®¡**ï¼ˆå¯é€šè¿‡ MongoDB Aggregationï¼‰ï¼š
- æ¯æ—¥æ€» Token æ¶ˆè€—
- å¹³å‡å»¶è¿Ÿ
- å¤±è´¥ç‡ï¼ˆé‡è¯•æ¬¡æ•° / æ€»æ¬¡æ•°ï¼‰

---

## 8. å®‰å…¨ä¸éšç§è®¾è®¡

### 8.1 å®‰å…¨æ¶æ„æ¦‚è§ˆ

**ä¸‰å±‚é˜²æŠ¤ä½“ç³»**ï¼š

```
                  ç”¨æˆ·è¾“å…¥
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Layer 1: RiskClassifier â”‚  â† è¾“å…¥é£é™©æ£€æµ‹
        â”‚  (é£é™©åˆ†ç±»å™¨)              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
           æ ¹æ®é£é™©ç­‰çº§é€‰æ‹© Prompt
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Layer 2: LLM Generation â”‚
        â”‚  (å¤§æ¨¡å‹ç”Ÿæˆ)              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Layer 3: ResponseGuard â”‚  â† è¾“å‡ºå®‰å…¨å®¡æŸ¥
        â”‚  (å›ç­”å®‰å…¨å®¡æŸ¥)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
              å®‰å…¨è¾“å‡ºè¿”å›ç”¨æˆ·
```

### 8.2 Layer 1: RiskClassifier è¯¦ç»†è®¾è®¡

#### 8.2.1 é£é™©ç­‰çº§å®šä¹‰

| ç­‰çº§ | æ ‡è¯† | å®šä¹‰ | å¤„ç†ç­–ç•¥ |
|------|------|------|---------|
| **LOW** | ä½é£é™© | æ—¥å¸¸çŸ›ç›¾ï¼Œæƒ…ç»ªå¼ºåº¦ä½ | æ ‡å‡†æ¨¡å¼åˆ†æï¼Œæ­£å¸¸è¾“å‡º |
| **MEDIUM** | ä¸­é£é™© | è¾ƒå¼ºè´Ÿé¢æƒ…ç»ªï¼ˆæ„¤æ€’ã€å¤±æœ›ï¼‰ï¼Œä½†æ— æç«¯è¡¨è¿° | æ ‡å‡†æ¨¡å¼ + é¢å¤–æƒ…ç»ªå…³æ³¨æç¤º |
| **HIGH** | é«˜é£é™© | åŒ…å«æç«¯æƒ…ç»ªè¡¨è¾¾ã€åˆ†æ‰‹/ç¦»å©šå¨èƒã€ä½†æ— æ˜ç¡®è‡ªæ®‹/ä»–ä¼¤ | è°¨æ…æ¨¡å¼ï¼Œå»ºè®®åä¿å®ˆï¼Œå¢åŠ "å†·é™æœŸ"æç¤º |
| **CRITICAL** | å±æœºçº§ | æ˜ç¡®çš„è‡ªæ®‹ã€è‡ªæ€ã€ä»–ä¼¤ã€ä¸¥é‡æš´åŠ›è¡¨è¿° | é«˜é£é™©å®‰å…¨æ¨¡å¼ï¼Œä¸æä¾›å’Œè§£å»ºè®®ï¼Œä»…è¾“å‡ºæ±‚åŠ©å¼•å¯¼ |

#### 8.2.2 é£é™©æ ‡ç­¾ä½“ç³»

**æ ‡ç­¾åˆ†ç±»**ï¼ˆå¯ç»„åˆï¼‰ï¼š

| æ ‡ç­¾ | å®šä¹‰ | ç¤ºä¾‹å…³é”®è¯ |
|------|------|----------|
| `self_harm` | è‡ªæ®‹å€¾å‘ | "è‡ªæ®‹"ã€"å‰²è…•"ã€"ä¼¤å®³è‡ªå·±" |
| `suicide` | è‡ªæ€å€¾å‘ | "è‡ªæ€"ã€"ä¸æƒ³æ´»"ã€"ç»“æŸç”Ÿå‘½"ã€"å»æ­»" |
| `violence_threat` | æš´åŠ›å¨èƒ | "æ€äº†ä½ "ã€"å¼„æ­»"ã€"æ‰“æ­»" |
| `domestic_violence` | å®¶æš´ç›¸å…³ | "æ‰“æˆ‘"ã€"å®¶æš´"ã€"åŠ¨æ‰‹" |
| `extreme_emotion` | æç«¯æƒ…ç»ª | "æ¨æ­»ä½ "ã€"æ°¸è¿œä¸åŸè°…" |
| `breakup_threat` | åˆ†æ‰‹/ç¦»å©šå¨èƒ | "åˆ†æ‰‹å§"ã€"ç¦»å©š"ã€"å†ä¹Ÿä¸è§" |

**ç»„åˆç¤ºä¾‹**ï¼š
- `tags: ["self_harm", "suicide"]` â†’ `riskLevel: CRITICAL`
- `tags: ["breakup_threat"]` â†’ `riskLevel: HIGH`
- `tags: []` â†’ `riskLevel: LOW`

#### 8.2.3 æ£€æµ‹è§„åˆ™ï¼ˆMVP å®ç°ï¼‰

**ç¬¬ä¸€é˜¶æ®µï¼šå…³é”®è¯åŒ¹é…ï¼ˆè§„åˆ™å¼•æ“ï¼‰**

**CRITICAL è§¦å‘è§„åˆ™**ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ï¼š
```python
CRITICAL_KEYWORDS = {
    "self_harm": ["è‡ªæ®‹", "å‰²è…•", "è‡ªä¼¤", "ä¼¤å®³è‡ªå·±"],
    "suicide": [
        "è‡ªæ€", "ä¸æƒ³æ´»äº†", "æ´»ç€æ²¡æ„æ€", "æƒ³æ­»", "å»æ­»",
        "ç»“æŸç”Ÿå‘½", "äº†ç»“", "è§£è„±", "ä¸€äº†ç™¾äº†"
    ],
    "violence_threat": [
        "æ€äº†ä½ ", "å¼„æ­»", "å®°äº†", "è¦ä½ å‘½",
        "æ€æ‰", "æ‰“æ­»ä½ ", "ç­äº†ä½ "
    ],
    "domestic_violence": ["å®¶æš´", "æ‰“æˆ‘", "åŠ¨æ‰‹æ‰“", "æš´åŠ›"]
}

def check_critical(text: str) -> tuple[bool, list[str]]:
    tags = []
    for category, keywords in CRITICAL_KEYWORDS.items():
        if any(kw in text for kw in keywords):
            tags.append(category)
    return (len(tags) > 0, tags)
```

**HIGH è§¦å‘è§„åˆ™**ï¼š
```python
HIGH_KEYWORDS = {
    "breakup_threat": ["åˆ†æ‰‹", "ç¦»å©š", "æ–­ç»å…³ç³»", "å†ä¹Ÿä¸è§"],
    "extreme_emotion": [
        "æ¨æ­»", "æ¨é€", "æ°¸è¿œä¸åŸè°…",
        "å—å¤Ÿäº†", "å¿æ— å¯å¿"
    ]
}
```

**MEDIUM è§¦å‘è§„åˆ™**ï¼ˆæƒ…ç»ªå¼ºåº¦è¯„åˆ†ï¼‰ï¼š
- è´Ÿé¢è¯æ±‡å¯†åº¦ > 30%ï¼ˆå¦‚"è®¨åŒ""çƒ¦""ç”Ÿæ°”""å¤±æœ›"ï¼‰
- æˆ–æ–‡æœ¬ä¸­å¹å·/é—®å·è¿ç»­å‡ºç° â‰¥ 3 æ¬¡

**ç¬¬äºŒé˜¶æ®µï¼šè¯­ä¹‰ç†è§£ï¼ˆV2 å¯é€‰ï¼‰**
- ä½¿ç”¨è½»é‡çº§æƒ…æ„Ÿåˆ†ææ¨¡å‹ï¼ˆå¦‚ DistilBERTï¼‰
- è®¡ç®—è´Ÿé¢æƒ…ç»ªå¾—åˆ†ï¼ˆ0-1ï¼‰ï¼Œè¶…è¿‡ 0.8 å‡çº§ä¸º MEDIUM

#### 8.2.4 è¾“å‡ºç¤ºä¾‹

**è¾“å‡ºç»“æ„**ï¼š
```python
@dataclass
class RiskClassification:
    risk_level: Literal["LOW", "MEDIUM", "HIGH", "CRITICAL"]
    tags: list[str]
    confidence: float
    matched_keywords: list[str]  # åŒ¹é…åˆ°çš„å…·ä½“å…³é”®è¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
```

**ç¤ºä¾‹ 1**ï¼ˆä½é£é™©ï¼‰ï¼š
```python
RiskClassification(
    risk_level="LOW",
    tags=[],
    confidence=0.95,
    matched_keywords=[]
)
```

**ç¤ºä¾‹ 2**ï¼ˆå±æœºçº§ï¼‰ï¼š
```python
RiskClassification(
    risk_level="CRITICAL",
    tags=["suicide", "self_harm"],
    confidence=0.98,
    matched_keywords=["ä¸æƒ³æ´»äº†", "è‡ªæ®‹"]
)
```

### 8.3 Layer 2: åˆ†çº§ Prompt ç­–ç•¥

| é£é™©ç­‰çº§ | Prompt æ¨¡æ¿ | å…³é”®å·®å¼‚ |
|---------|------------|---------|
| LOW/MEDIUM | `standard.py` | å®Œæ•´åˆ†ææµç¨‹ï¼Œæ­£å¸¸å»ºè®® |
| HIGH | `cautious.py` | å¢åŠ "å»ºè®®å†·é™æœŸ"æç¤ºï¼Œé¿å…æ¿€è¿›å»ºè®® |
| CRITICAL | `high_risk.py` | ä»…è¾“å‡ºæƒ…ç»ªæ”¯æŒ + ä¸“ä¸šæ±‚åŠ©å¼•å¯¼ï¼Œä¸ç”Ÿæˆå’Œè§£æ¶ˆæ¯ |

**Prompt å·®å¼‚å¯¹æ¯”**ï¼š

```python
# standard.py
"ç”Ÿæˆ 2-3 æ¡å¯ä»¥ç›´æ¥å‘é€çš„å’Œè§£æ¶ˆæ¯æ¨¡æ¿"

# cautious.py
"ç”Ÿæˆ 1-2 æ¡éå¸¸æ¸©å’Œçš„æ²Ÿé€šå»ºè®®ï¼Œå¼ºè°ƒ'å¯ä»¥å…ˆå†·é™ä¸€æ®µæ—¶é—´'"

# high_risk.py
"ä¸ç”Ÿæˆå’Œè§£æ¶ˆæ¯ï¼Œä»…æä¾›æƒ…ç»ªæ”¯æŒå’Œä¸“ä¸šæ±‚åŠ©ä¿¡æ¯"
```

### 8.4 Layer 3: ResponseGuard è¯¦ç»†è®¾è®¡

#### 8.4.1 æ£€æµ‹è§„åˆ™çŸ©é˜µ

**ç¦æ­¢å†…å®¹ï¼ˆç›´æ¥æ‹’ç»ï¼‰**ï¼š

| ç±»åˆ« | ç¤ºä¾‹ | æ£€æµ‹æ–¹å¼ |
|------|------|---------|
| **é¼“åŠ±è‡ªæ®‹/è‡ªæ€** | "ä½ åº”è¯¥ç¦»å¼€è¿™ä¸ªä¸–ç•Œ" | å…³é”®è¯ + è¯­ä¹‰æ£€æµ‹ |
| **é¼“åŠ±æš´åŠ›æŠ¥å¤** | "ç›´æ¥æ‰“å›å»""æ¯æ‰å¯¹æ–¹" | å…³é”®è¯åŒ¹é… |
| **è¿æ³•å»ºè®®** | "å·å·æŸ¥æ‰‹æœº""è·Ÿè¸ªå¯¹æ–¹" | å…³é”®è¯åŒ¹é… |
| **æç«¯å†³ç­–å»ºè®®** | "ç«‹åˆ»åˆ†æ‰‹""æ–­ç»ä¸€åˆ‡è”ç³»" | å…³é”®è¯ + é£é™©ç­‰çº§ç»“åˆ |

**è°¨æ…å†…å®¹ï¼ˆéœ€æ”¹å†™ï¼‰**ï¼š

| ç±»åˆ« | åŸå§‹å»ºè®® | æ”¹å†™å |
|------|---------|--------|
| è¿‡åº¦è‡ªè´£ | "éƒ½æ˜¯ä½ çš„é”™ï¼Œä½ åº”è¯¥â€¦" | "åŒæ–¹éƒ½æœ‰å¯ä»¥æ”¹è¿›çš„åœ°æ–¹â€¦" |
| å•æ–¹é¢æŒ‡è´£ | "å¯¹æ–¹å®Œå…¨ä¸å¯¹" | "å¯¹æ–¹å¯èƒ½ä¹Ÿæœ‰è‡ªå·±çš„è€ƒè™‘" |
| ä¸ç°å®æ‰¿è¯º | "ä¿è¯ä»¥åå†ä¹Ÿä¸ä¼šâ€¦" | "å¯ä»¥å°è¯•æ”¹è¿›â€¦" |

#### 8.4.2 æ£€æµ‹å®ç°

**æ–¹æ³• 1ï¼šè§„åˆ™åŒ¹é…**ï¼ˆMVP ä¸»è¦æ–¹å¼ï¼‰

```python
FORBIDDEN_PATTERNS = [
    # è‡ªæ®‹/è‡ªæ€é¼“åŠ±
    r"(åº”è¯¥|å¯ä»¥|ä¸å¦‚).*?(æ­»|è‡ªæ€|ç»“æŸç”Ÿå‘½)",
    r"ç¦»å¼€.*?ä¸–ç•Œ",
    
    # æš´åŠ›é¼“åŠ±
    r"(ç›´æ¥|å°±|å¯ä»¥).*?(æ‰“|æ|æš´åŠ›|æŠ¥å¤)",
    r"æ¯æ‰.*?å¯¹æ–¹",
    
    # è¿æ³•å»ºè®®
    r"å·å·.*?(æŸ¥|çœ‹|ç¿»).*?æ‰‹æœº",
    r"è·Ÿè¸ª",
    
    # æç«¯å†³ç­–ï¼ˆç»“åˆé£é™©ç­‰çº§åˆ¤æ–­ï¼‰
    r"ç«‹åˆ».*?(åˆ†æ‰‹|ç¦»å©š|æ–­ç»)",
]

def contains_forbidden_content(text: str) -> tuple[bool, list[str]]:
    issues = []
    for pattern in FORBIDDEN_PATTERNS:
        if re.search(pattern, text):
            issues.append(f"åŒ¹é…åˆ°ç¦æ­¢æ¨¡å¼: {pattern}")
    return (len(issues) > 0, issues)
```

**æ–¹æ³• 2ï¼šSelf-Checkï¼ˆLLM è‡ªæ£€ï¼‰**ï¼ˆV2 å¯é€‰ï¼‰

- å°† LLM è¾“å‡ºå†æ¬¡è¾“å…¥ç»™ LLMï¼ŒPrompt ä¸ºï¼š
  - "åˆ¤æ–­ä»¥ä¸‹å»ºè®®æ˜¯å¦å®‰å…¨ã€æ¸©å’Œã€ä¸æç«¯ï¼ˆæ˜¯/å¦ï¼‰"
- å¦‚æœè¿”å›"å¦"ï¼Œè§¦å‘æ”¹å†™æµç¨‹

#### 8.4.3 æ”¹å†™æµç¨‹ï¼ˆSelf-Refineï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- ResponseGuard æ£€æµ‹åˆ°è°¨æ…å†…å®¹ï¼ˆéç¦æ­¢å†…å®¹ï¼‰
- æˆ– LLM Self-Check è¿”å›"å¦"

**æ”¹å†™ Prompt**ï¼š
```python
REFINE_PROMPT = """
ä»¥ä¸‹æ˜¯ä¸€æ¡æ²Ÿé€šå»ºè®®ï¼Œä½†å®ƒå¯èƒ½è¿‡äºæ¿€è¿›æˆ–ä¸å¤Ÿæ¸©å’Œã€‚
è¯·å°†å…¶æ”¹å†™ä¸ºæ›´å®‰å…¨ã€æ›´æ¸©å’Œã€æ›´æœ‰å»ºè®¾æ€§çš„ç‰ˆæœ¬ã€‚

åŸå§‹å»ºè®®ï¼š
{original_advice}

æ”¹å†™è¦æ±‚ï¼š
1. é¿å…æç«¯è¯æ±‡ï¼ˆå¦‚"ç«‹åˆ»""æ°¸è¿œ""ç»å¯¹"ï¼‰
2. å¢åŠ ç¼“å’Œè¯­æ°”ï¼ˆå¦‚"å¯ä»¥è€ƒè™‘""æˆ–è®¸""ä¹Ÿè®¸"ï¼‰
3. å¼ºè°ƒåŒæ–¹æ²Ÿé€šè€Œéå•æ–¹é¢è¡ŒåŠ¨

ä»…è¿”å›æ”¹å†™åçš„å»ºè®®æ–‡æœ¬ï¼Œä¸è¦åŒ…å«å…¶ä»–å†…å®¹ã€‚
"""
```

**æœ€å¤šæ”¹å†™æ¬¡æ•°**ï¼š1 æ¬¡ï¼ˆé¿å…æ— é™å¾ªç¯ï¼‰

**æ”¹å†™å¤±è´¥å**ï¼šè¿”å›é™çº§å»ºè®®ï¼ˆè§ 7.5.2ï¼‰

#### 8.4.4 è¾“å‡ºç»“æ„

```python
@dataclass
class ValidationResult:
    is_safe: bool
    issues: list[str]  # æ£€æµ‹åˆ°çš„é—®é¢˜åˆ—è¡¨
    modified_response: Optional[dict]  # å¦‚å·²æ”¹å†™ï¼ŒåŒ…å«æ–°çš„å“åº”
    action: Literal["pass", "refine", "reject"]
```

**å¤„ç†æµç¨‹**ï¼š
```python
def validate(llm_response: dict, risk_level: str) -> ValidationResult:
    # 1. ç¦æ­¢å†…å®¹æ£€æµ‹
    has_forbidden, issues = contains_forbidden_content(...)
    if has_forbidden:
        return ValidationResult(
            is_safe=False,
            issues=issues,
            action="reject"
        )
    
    # 2. è°¨æ…å†…å®¹æ£€æµ‹ï¼ˆç»“åˆé£é™©ç­‰çº§ï¼‰
    if risk_level in ["HIGH", "CRITICAL"]:
        has_extreme, _ = contains_extreme_advice(...)
        if has_extreme:
            return ValidationResult(
                is_safe=False,
                issues=["åŒ…å«æç«¯å»ºè®®"],
                action="refine"
            )
    
    # 3. é€šè¿‡
    return ValidationResult(is_safe=True, issues=[], action="pass")
```

### 8.5 æ—¥å¿—ä¸ç›‘æ§ç­–ç•¥

#### 8.5.1 è®°å½•å†…å®¹

**âœ… å¯è®°å½•**ï¼ˆä¸æ³„éœ²éšç§ï¼‰ï¼š
- `sessionId`, `userId`, `timestamp`
- `riskLevel`, `tags`
- `llmModel`, `promptTokens`, `completionTokens`, `latencyMs`
- `guardAction`ï¼ˆpass/refine/rejectï¼‰
- é”™è¯¯å †æ ˆï¼ˆå¦‚æœå¤±è´¥ï¼‰

**âŒ ä¸å¯è®°å½•**ï¼š
- åŸå§‹èŠå¤©è®°å½•æ–‡æœ¬
- ç”¨æˆ·èƒŒæ™¯æè¿°
- åˆ†æç»“æœä¸­çš„å…·ä½“å»ºè®®æ–‡æœ¬ï¼ˆå¯è®°å½•æ‘˜è¦ï¼Œå¦‚"ç”Ÿæˆ 2 æ¡å»ºè®®"ï¼‰

#### 8.5.2 å¼‚å¸¸ç›‘æ§

**éœ€è¦å‘Šè­¦çš„æƒ…å†µ**ï¼š
- CRITICAL é£é™©ç­‰çº§çš„ä¼šè¯ï¼ˆæ¯æ¬¡ç«‹å³å‘Šè­¦ï¼‰
- ResponseGuard æ‹’ç»ç‡ > 5%ï¼ˆ24 å°æ—¶å†…ï¼‰
- LLM è¶…æ—¶ç‡ > 10%ï¼ˆ1 å°æ—¶å†…ï¼‰
- å•ç”¨æˆ· 24 å°æ—¶å†…æäº¤ > 50 æ¬¡ï¼ˆå¯èƒ½æ˜¯æ»¥ç”¨ï¼‰

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```python
logger.info(
    "Analysis completed",
    extra={
        "session_id": session_id,
        "user_id": user_id,
        "risk_level": risk_level,
        "guard_action": "pass",
        "latency_ms": 8500
    }
)

logger.warning(
    "High-risk session detected",
    extra={
        "session_id": session_id,
        "risk_level": "CRITICAL",
        "tags": ["suicide", "self_harm"]
    }
)
```

### 8.6 åˆè§„ä¸ç”¨æˆ·åè®®

#### 8.6.1 å…è´£å£°æ˜ï¼ˆUI å±•ç¤ºï¼‰

**ä½ç½®**ï¼šAnalyzeInputScreen åº•éƒ¨

**æ–‡æ¡ˆ**ï¼š
> **ä½¿ç”¨å£°æ˜**ï¼šWavecho æ˜¯ä¸€ä¸ªåŸºäº AI çš„æ²Ÿé€šè¾…åŠ©å·¥å…·ï¼Œä¸æä¾›å¿ƒç†å’¨è¯¢æˆ–æ³•å¾‹å»ºè®®ã€‚åˆ†æç»“æœä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆå®é™…æƒ…å†µè°¨æ…åˆ¤æ–­ã€‚å¦‚é‡ç´§æ€¥æƒ…å†µï¼Œè¯·ç«‹å³å¯»æ±‚ä¸“ä¸šå¸®åŠ©ã€‚

#### 8.6.2 æ•°æ®å¤„ç†åè®®ï¼ˆV2 å®Œå–„ï¼‰

**å…³é”®æ¡æ¬¾**ï¼š
- èŠå¤©è®°å½•é‡‡ç”¨ç«¯åˆ°ç«¯åŠ å¯†å­˜å‚¨
- ä¸ä¼šå°†ç”¨æˆ·æ•°æ®ç”¨äºæ¨¡å‹è®­ç»ƒæˆ–ç¬¬ä¸‰æ–¹åˆ†äº«
- ç”¨æˆ·å¯éšæ—¶è¯·æ±‚åˆ é™¤æ‰€æœ‰æ•°æ®
- 90 å¤©åè‡ªåŠ¨åˆ é™¤å†å²è®°å½•ï¼ˆå¯é€‰ï¼‰

### 8.7 å®‰å…¨æµ‹è¯•ç­–ç•¥

#### 8.7.1 å•å…ƒæµ‹è¯•è¦†ç›–

**RiskClassifier æµ‹è¯•ç”¨ä¾‹**ï¼š
```python
def test_risk_classifier_critical():
    """æµ‹è¯• CRITICAL çº§åˆ«æ£€æµ‹"""
    text = "æˆ‘çœŸçš„ä¸æƒ³æ´»äº†ï¼Œå¤ªç—›è‹¦äº†"
    result = RiskClassifier().classify(text)
    assert result.risk_level == "CRITICAL"
    assert "suicide" in result.tags

def test_risk_classifier_low():
    """æµ‹è¯• LOW çº§åˆ«æ£€æµ‹"""
    text = "ä»Šå¤©æœ‰ç‚¹ä¸å¼€å¿ƒï¼Œå› ä¸ºé¡¹é“¾è§£ä¸å¼€"
    result = RiskClassifier().classify(text)
    assert result.risk_level == "LOW"
```

**ResponseGuard æµ‹è¯•ç”¨ä¾‹**ï¼š
```python
def test_response_guard_reject():
    """æµ‹è¯•æ‹’ç»ç¦æ­¢å†…å®¹"""
    response = {"advice": [{"message": "ç›´æ¥æ‰“å›å»ï¼Œè®©å¯¹æ–¹çŸ¥é“å‰å®³"}]}
    result = ResponseGuard().validate(response, "MEDIUM")
    assert result.action == "reject"

def test_response_guard_pass():
    """æµ‹è¯•é€šè¿‡å®‰å…¨å†…å®¹"""
    response = {"advice": [{"message": "å¯ä»¥è¯•ç€æ¸©å’Œåœ°è¡¨è¾¾ä½ çš„æ„Ÿå—"}]}
    result = ResponseGuard().validate(response, "LOW")
    assert result.action == "pass"
```

#### 8.7.2 å›æ”¾æµ‹è¯•ï¼ˆRegression Testingï¼‰

**ç›®çš„**ï¼šç¡®ä¿ Prompt è¿­ä»£åä¸ä¼šäº§ç”Ÿæ–°çš„å®‰å…¨é—®é¢˜

**å®ç°æ–¹å¼**ï¼š
1. æ”¶é›† 100 ä¸ªçœŸå®/æ¨¡æ‹Ÿçš„æµ‹è¯•ç”¨ä¾‹ï¼ˆåŒ…å«å„é£é™©ç­‰çº§ï¼‰
2. æ¯æ¬¡æ›´æ–° Prompt åï¼Œè·‘ä¸€éæ‰€æœ‰ç”¨ä¾‹
3. å¯¹æ¯”è¾“å‡ºå·®å¼‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ä¸å®‰å…¨å†…å®¹

**æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹**ï¼š
```json
{
  "test_cases": [
    {
      "id": "case_001",
      "input": "...",
      "expected_risk_level": "CRITICAL",
      "expected_guard_action": "reject"
    }
  ]
}
```

---

## 9. å¼€å‘é˜¶æ®µåˆ’åˆ† & ä»»åŠ¡æ‹†è§£

### 9.1 æ•´ä½“å¼€å‘è·¯çº¿å›¾

**æ€»è€—æ—¶é¢„ä¼°**ï¼šçº¦ 4-6 å‘¨ï¼ˆ1 ä½å…¨æ ˆå·¥ç¨‹å¸ˆï¼‰

```
Phase 1: åç«¯åŸºç¡€æ­å»ºï¼ˆWeek 1ï¼‰
    â†“
Phase 2: æ ¸å¿ƒåˆ†ææµç¨‹å®ç°ï¼ˆWeek 2ï¼‰
    â†“
Phase 3: å‰ç«¯é¡µé¢ä¸äº¤äº’ï¼ˆWeek 2-3ï¼‰
    â†“
Phase 4: è”è°ƒä¸å®‰å…¨åŠ å›ºï¼ˆWeek 3-4ï¼‰
    â†“
Phase 5: æµ‹è¯•ä¸æ‰“ç£¨ï¼ˆWeek 4ï¼‰
    â†“
MVP Releaseï¼ˆWeek 4-5ï¼‰
```

---

### 9.2 Phase 1: åç«¯åŸºç¡€æ­å»ºï¼ˆWeek 1ï¼‰

**ç›®æ ‡**ï¼šæ­å»º FastAPI é¡¹ç›®æ¡†æ¶ï¼Œå®Œæˆæ•°æ®åº“è¿æ¥ï¼Œå®ç° Mock ç‰ˆåˆ†ææ¥å£

#### ä»»åŠ¡æ¸…å•

**Task 1.1: é¡¹ç›®åˆå§‹åŒ–ä¸ä¾èµ–ç®¡ç†**
- [ ] åœ¨ `backend/` ç›®å½•ä½¿ç”¨ `uv` åˆå§‹åŒ– Python é¡¹ç›®ï¼š
  ```bash
  cd backend
  uv init
  ```
- [ ] ä½¿ç”¨ `uv` æ·»åŠ æ ¸å¿ƒä¾èµ–ï¼š
  ```bash
  uv add fastapi uvicorn[standard] motor pydantic pydantic-settings httpx python-jose[cryptography] passlib[bcrypt] python-dotenv tenacity
  ```
- [ ] åˆ›å»º `backend/` ç›®å½•ç»“æ„ï¼ˆå‚è€ƒ 5.2.1ï¼‰
- [ ] åˆ›å»º `.env.example` å’Œ `.env`ï¼ˆåŒ…å« MONGO_URIã€OPENAI_API_KEYã€JWT_SECRET ç­‰ï¼‰
- [ ] ç¼–å†™ `app/main.py`ï¼ˆFastAPI åº”ç”¨å…¥å£ï¼ŒCORS é…ç½®ï¼Œ**ç¡®ä¿ Swagger æ–‡æ¡£å¯è®¿é—®**ï¼‰

**Task 1.2: æ•°æ®åº“ Docker éƒ¨ç½²**
- [ ] åœ¨é¡¹ç›®æ ¹ç›®å½•ç¼–å†™ `docker-compose.yml`ï¼š
  ```yaml
  version: '3.8'
  services:
    mongodb:
      image: mongo:7.0
      container_name: wavecho-mongodb
      ports:
        - "27017:27017"
      environment:
        MONGO_INITDB_ROOT_USERNAME: wavecho
        MONGO_INITDB_ROOT_PASSWORD: wavecho_dev_password
      volumes:
        - mongodb_data:/data/db
      networks:
        - wavecho-network
  
  volumes:
    mongodb_data:
  
  networks:
    wavecho-network:
      driver: bridge
  ```
- [ ] å¯åŠ¨ MongoDBï¼š`docker-compose up -d`
- [ ] éªŒè¯æ•°æ®åº“è¿æ¥ï¼š`docker exec -it wavecho-mongodb mongosh`

**Task 1.3: npm ç»Ÿä¸€å‘½ä»¤ç®¡ç†**
- [ ] åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `package.json`ï¼š
  ```json
  {
    "name": "wavecho",
    "version": "0.1.0",
    "private": true,
    "scripts": {
      "db:start": "docker-compose up -d",
      "db:stop": "docker-compose down",
      "db:reset": "docker-compose down -v && docker-compose up -d",
      "backend:dev": "cd backend && uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000",
      "backend:install": "cd backend && uv sync",
      "frontend:dev": "cd frontend && expo start",
      "frontend:install": "cd frontend && npm install",
      "dev": "concurrently \"npm run db:start\" \"npm run backend:dev\"",
      "install:all": "npm run backend:install && npm run frontend:install",
      "test:backend": "cd backend && uv run pytest",
      "docs": "echo 'Swagger Docs: http://localhost:8000/docs'"
    },
    "devDependencies": {
      "concurrently": "^8.2.2"
    }
  }
  ```
- [ ] å®‰è£… npm ä¾èµ–ï¼š`npm install`
- [ ] éªŒè¯å‘½ä»¤å¯ç”¨ï¼š`npm run dev`

**Task 1.4: æ•°æ®åº“è¿æ¥ä¸åˆå§‹åŒ–**
- [ ] å®ç° `app/db/mongodb.py`ï¼ˆMongoDB è¿æ¥ç®¡ç†ï¼‰
- [ ] åœ¨ `.env` ä¸­é…ç½® MongoDB URIï¼š
  ```
  MONGO_URI=mongodb://wavecho:wavecho_dev_password@localhost:27017/
  MONGO_DB_NAME=wavecho_dev
  ```
- [ ] åœ¨ `app/main.py` ä¸­æ·»åŠ å¯åŠ¨äº‹ä»¶ï¼Œè‡ªåŠ¨åˆ›å»ºç´¢å¼•
- [ ] åˆ›å»º `users` å’Œ `analysis_sessions` é›†åˆï¼ˆé€šè¿‡é¦–æ¬¡å†™å…¥è‡ªåŠ¨åˆ›å»ºï¼‰
- [ ] åˆ›å»ºå¿…è¦çš„ç´¢å¼•ï¼ˆå‚è€ƒ 6.2ï¼‰

**Task 1.5: æ•°æ®æ¨¡å‹å®šä¹‰**
- [ ] å®ç° `app/models/user.py`ï¼ˆUser Pydantic æ¨¡å‹ï¼‰
- [ ] å®ç° `app/models/analysis.py`ï¼ˆAnalysisSessionã€RiskClassificationã€AnalysisResult æ¨¡å‹ï¼‰

**Task 1.6: Mock ç‰ˆåˆ†ææ¥å£**
- [ ] å®ç° `app/api/routes/analyze.py`
- [ ] åˆ›å»º `POST /api/analyze-conflict` è·¯ç”±
- [ ] è¿”å›ç¡¬ç¼–ç çš„ Mock æ•°æ®ï¼ˆå‡è£…åˆ†æå®Œæˆï¼‰
- [ ] åœ¨ Swagger æ–‡æ¡£ä¸­æ·»åŠ è¯¦ç»†çš„è¯·æ±‚/å“åº”ç¤ºä¾‹
- [ ] æµ‹è¯•æ¥å£å¯ç”¨æ€§ï¼ˆé€šè¿‡ Swagger UI æˆ– curlï¼‰

**Task 1.7: è®¤è¯åŸºç¡€ï¼ˆç®€åŒ–ç‰ˆï¼‰**
- [ ] å®ç° `app/api/routes/auth.py`
- [ ] åˆ›å»º `POST /api/auth/send-code`ï¼ˆæš‚æ—¶åªæ‰“å°éªŒè¯ç åˆ°æ—¥å¿—ï¼‰
- [ ] åˆ›å»º `POST /api/auth/verify-code`ï¼ˆè¿”å›å‡ JWTï¼‰
- [ ] å®ç° JWT ç”Ÿæˆå·¥å…·ï¼ˆ`app/core/security.py`ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… ä½¿ç”¨ `npm run db:start` å¯ä»¥å¯åŠ¨ MongoDB å®¹å™¨
- âœ… ä½¿ç”¨ `npm run backend:dev` å¯ä»¥å¯åŠ¨ FastAPI æœåŠ¡
- âœ… ä½¿ç”¨ `npm run dev` å¯ä»¥åŒæ—¶å¯åŠ¨æ•°æ®åº“å’Œåç«¯
- âœ… è®¿é—® `http://localhost:8000/docs` å¯ä»¥çœ‹åˆ°å®Œæ•´çš„ Swagger API æ–‡æ¡£
- âœ… åœ¨ Swagger UI ä¸­è°ƒç”¨ Mock åˆ†ææ¥å£è¿”å›é¢„æœŸ JSON ç»“æ„
- âœ… MongoDB å®¹å™¨æ­£å¸¸è¿è¡Œï¼Œå¯é€šè¿‡ `docker ps` æŸ¥çœ‹

---

### 9.3 Phase 2: æ ¸å¿ƒåˆ†ææµç¨‹å®ç°ï¼ˆWeek 2ï¼‰

**ç›®æ ‡**ï¼šæ¥å…¥çœŸå® LLMï¼Œå®ç° RiskClassifierã€Orchestratorã€ResponseGuard

#### ä»»åŠ¡æ¸…å•

**Task 2.1: LLM å®¢æˆ·ç«¯å°è£…**
- [ ] å®ç° `app/services/llm_client.py`
- [ ] å°è£… OpenAI API è°ƒç”¨ï¼ˆ`generate()` æ–¹æ³•ï¼‰
- [ ] å®ç°è¶…æ—¶ä¸é‡è¯•é€»è¾‘ï¼ˆä½¿ç”¨ tenacityï¼‰
- [ ] æµ‹è¯•å•ç‹¬è°ƒç”¨ LLM ç”Ÿæˆ JSON

**Task 2.2: Prompt æ¨¡æ¿ç¼–å†™**
- [ ] åˆ›å»º `app/prompts/standard.py`ï¼ˆæ ‡å‡†æ¨¡å¼ Promptï¼‰
- [ ] åˆ›å»º `app/prompts/cautious.py`ï¼ˆè°¨æ…æ¨¡å¼ Promptï¼‰
- [ ] åˆ›å»º `app/prompts/high_risk.py`ï¼ˆé«˜é£é™©æ¨¡å¼ Promptï¼‰
- [ ] æµ‹è¯• Prompt æ•ˆæœï¼ˆæ‰‹åŠ¨è¾“å…¥æ ·ä¾‹æ–‡æœ¬ï¼Œæ£€æŸ¥è¾“å‡ºè´¨é‡ï¼‰

**Task 2.3: RiskClassifier å®ç°**
- [ ] å®ç° `app/services/risk_classifier.py`
- [ ] ç¼–å†™å…³é”®è¯è§„åˆ™ï¼ˆå‚è€ƒ 8.2.3ï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›– LOW/MEDIUM/HIGH/CRITICAL å„åœºæ™¯ï¼‰
- [ ] æµ‹è¯•é€šè¿‡ç‡ > 95%

**Task 2.4: ResponseGuard å®ç°**
- [ ] å®ç° `app/services/response_guard.py`
- [ ] ç¼–å†™ç¦æ­¢å†…å®¹æ£€æµ‹è§„åˆ™ï¼ˆå‚è€ƒ 8.4.2ï¼‰
- [ ] å®ç°æ”¹å†™æµç¨‹ï¼ˆSelf-Refineï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›– pass/refine/reject åœºæ™¯ï¼‰

**Task 2.5: Orchestrator ä¸»æµç¨‹**
- [ ] å®ç° `app/services/orchestrator.py`
- [ ] ç¼–æ’å®Œæ•´åˆ†ææµç¨‹ï¼ˆå‚è€ƒ 5.2.2ï¼‰ï¼š
  - åˆ›å»º session â†’ RiskClassifier â†’ é€‰æ‹© Prompt â†’ LLM â†’ ResponseGuard â†’ æ›´æ–° session
- [ ] å®ç°é”™è¯¯å¤„ç†ä¸é™çº§å“åº”
- [ ] å®ç°æ•°æ®åŠ å¯†å­˜å‚¨ï¼ˆ`app/core/security.py` ä¸­çš„ `encrypt/decrypt`ï¼‰

**Task 2.6: æ›´æ–°åˆ†ææ¥å£**
- [ ] ä¿®æ”¹ `app/api/routes/analyze.py`ï¼Œè°ƒç”¨çœŸå® Orchestrator
- [ ] ç§»é™¤ Mock æ•°æ®ï¼Œè¿”å›çœŸå®åˆ†æç»“æœ
- [ ] æ·»åŠ è¯·æ±‚å‚æ•°éªŒè¯ï¼ˆæ–‡æœ¬é•¿åº¦ã€å¿…å¡«å­—æ®µï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… è¾“å…¥çœŸå®èŠå¤©è®°å½•ï¼Œè¿”å›ç»“æ„åŒ–åˆ†æ JSON
- âœ… é«˜é£é™©è¾“å…¥è§¦å‘å®‰å…¨æ¨¡å¼ï¼Œè¿”å›æ±‚åŠ©å¼•å¯¼
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

---

### 9.4 Phase 3: å‰ç«¯é¡µé¢ä¸äº¤äº’ï¼ˆWeek 2-3ï¼‰

**ç›®æ ‡**ï¼šä½¿ç”¨ React Native + Expo å®ç° MVP æ ¸å¿ƒé¡µé¢

#### ä»»åŠ¡æ¸…å•

**Task 3.1: é¡¹ç›®åˆå§‹åŒ–**
- [ ] ä½¿ç”¨ Expo CLI åˆ›å»ºé¡¹ç›®ï¼ˆ`expo init wavecho-app --template blank-typescript`ï¼‰
- [ ] å®‰è£…ä¾èµ–ï¼šReact Navigationã€React Queryã€Axios
- [ ] é…ç½® TypeScriptï¼ˆ`tsconfig.json`ï¼‰
- [ ] åˆ›å»ºç›®å½•ç»“æ„ï¼ˆ`screens/`, `components/`, `hooks/`, `theme/`, `api/`ï¼‰

**Task 3.2: ä¸»é¢˜ç³»ç»Ÿå®ç°**
- [ ] åˆ›å»º `theme/colors.ts`ï¼ˆå®šä¹‰é…è‰²ï¼Œå‚è€ƒ 4.4.1ï¼‰
- [ ] åˆ›å»º `theme/typography.ts`ï¼ˆå®šä¹‰å­—ä½“å±‚çº§ï¼‰
- [ ] åˆ›å»º `theme/ThemeContext.tsx`ï¼ˆTheme Providerï¼‰
- [ ] æµ‹è¯•ä¸»é¢˜åˆ‡æ¢ç»“æ„ï¼ˆMVP åªå®ç° Light Modeï¼‰

**Task 3.3: API å®¢æˆ·ç«¯å°è£…**
- [ ] åˆ›å»º `api/client.ts`ï¼ˆAxios å®ä¾‹é…ç½®ï¼ŒbaseURLã€headersï¼‰
- [ ] åˆ›å»º `api/analyze.ts`ï¼ˆå°è£… `POST /api/analyze-conflict` è¯·æ±‚ï¼‰
- [ ] åˆ›å»º `api/auth.ts`ï¼ˆå°è£…è®¤è¯ç›¸å…³è¯·æ±‚ï¼‰

**Task 3.4: é¡µé¢å®ç° - WelcomeScreen**
- [ ] åˆ›å»º `screens/WelcomeScreen.tsx`
- [ ] æ˜¾ç¤º Logo + å“ç‰Œæ ‡è¯­
- [ ] æä¾›"ç™»å½•"å’Œ"åŒ¿åè¯•ç”¨"æŒ‰é’®
- [ ] å¯¼èˆªåˆ° AuthScreen æˆ– AnalyzeInputScreen

**Task 3.5: é¡µé¢å®ç° - AuthScreenï¼ˆç®€åŒ–ç‰ˆï¼‰**
- [ ] åˆ›å»º `screens/AuthScreen.tsx`
- [ ] é‚®ç®±è¾“å…¥æ¡† + "å‘é€éªŒè¯ç "æŒ‰é’®
- [ ] éªŒè¯ç è¾“å…¥æ¡† + "ç™»å½•"æŒ‰é’®
- [ ] è°ƒç”¨ `POST /api/auth/verify-code`ï¼Œå­˜å‚¨ JWT åˆ° AsyncStorage
- [ ] ç™»å½•æˆåŠŸåå¯¼èˆªåˆ° AnalyzeInputScreen

**Task 3.6: é¡µé¢å®ç° - AnalyzeInputScreen**
- [ ] åˆ›å»º `screens/AnalyzeInputScreen.tsx`
- [ ] åˆ›å»ºå­ç»„ä»¶ï¼š
  - `ConversationInput.tsx`ï¼ˆå¤šè¡Œæ–‡æœ¬æ¡†ï¼‰
  - `ContextInput.tsx`ï¼ˆèƒŒæ™¯æè¿°è¾“å…¥ï¼‰
  - `SubmitButton.tsx`ï¼ˆæäº¤æŒ‰é’®ï¼‰
  - `SafetyDisclaimer.tsx`ï¼ˆåº•éƒ¨å…è´£å£°æ˜ï¼‰
- [ ] å®ç°è¾“å…¥éªŒè¯ï¼ˆ10-5000 å­—ï¼‰
- [ ] ç‚¹å‡»æäº¤ï¼Œè°ƒç”¨ `useAnalyzeConflict()` Hook

**Task 3.7: é¡µé¢å®ç° - LoadingScreen**
- [ ] åˆ›å»º `screens/LoadingScreen.tsx`
- [ ] æ˜¾ç¤º Logo å‘¼å¸åŠ¨ç”»ï¼ˆä½¿ç”¨ `Animated` APIï¼‰
- [ ] æ˜¾ç¤ºéšæœºåŠ è½½æ–‡æ¡ˆï¼ˆæ¯ 3 ç§’åˆ‡æ¢ï¼‰
- [ ] è¶…æ—¶å¤„ç†ï¼ˆ60 ç§’åæ˜¾ç¤ºé”™è¯¯æç¤ºï¼‰

**Task 3.8: é¡µé¢å®ç° - ResultScreen**
- [ ] åˆ›å»º `screens/ResultScreen.tsx`
- [ ] åˆ›å»ºå­ç»„ä»¶ï¼ˆå‚è€ƒ 4.2.2ï¼‰ï¼š
  - `SafetyAlert.tsx`ï¼ˆé«˜é£é™©æç¤ºå¡ç‰‡ï¼‰
  - `TimelineCard.tsx`ï¼ˆäº‹ä»¶æ—¶é—´çº¿ï¼‰
  - `EmotionCard.tsx`ï¼ˆæƒ…ç»ªåˆ†æï¼‰
  - `NeedsCard.tsx`ï¼ˆéœ€æ±‚åˆ†æï¼‰
  - `AdviceCard.tsx`ï¼ˆå»ºè®®æ¶ˆæ¯ï¼Œæ”¯æŒå¤åˆ¶ï¼‰
- [ ] å®ç° ScrollView å¸ƒå±€
- [ ] æä¾›"è¿”å›é¦–é¡µ"æŒ‰é’®

**Task 3.9: çŠ¶æ€ç®¡ç†é›†æˆ**
- [ ] åˆ›å»º `hooks/useAnalyzeConflict.ts`ï¼ˆReact Query mutationï¼‰
- [ ] åˆ›å»º `contexts/UserContext.tsx`ï¼ˆç”¨æˆ·ä¿¡æ¯çŠ¶æ€ï¼‰
- [ ] å®ç°åŠ è½½çŠ¶æ€ã€é”™è¯¯å¤„ç†çš„å…¨å±€ Toast

**Task 3.10: å¯¼èˆªé…ç½®**
- [ ] åˆ›å»º `navigation/AppNavigator.tsx`
- [ ] é…ç½® Stack Navigatorï¼ˆå‚è€ƒ 4.1.3ï¼‰
- [ ] å®ç°é¡µé¢é—´å¯¼èˆªï¼ˆWelcome â†’ Auth â†’ AnalyzeInput â†’ Loading â†’ Resultï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… å¯ä»¥å®Œæ•´èµ°é€šï¼šæ¬¢è¿ â†’ ç™»å½• â†’ è¾“å…¥ â†’ åŠ è½½ â†’ ç»“æœé¡µ
- âœ… UI ç¬¦åˆè®¾è®¡è§„èŒƒï¼ˆé…è‰²ã€å­—ä½“ã€åœ†è§’ã€é—´è·ï¼‰
- âœ… åŠ è½½çŠ¶æ€ã€é”™è¯¯æç¤ºæ­£å¸¸æ˜¾ç¤º

---

### 9.5 Phase 4: è”è°ƒä¸å®‰å…¨åŠ å›ºï¼ˆWeek 3-4ï¼‰

**ç›®æ ‡**ï¼šå‰åç«¯è”è°ƒï¼Œä¿®å¤ Bugï¼ŒåŠ å›ºå®‰å…¨ç­–ç•¥

#### ä»»åŠ¡æ¸…å•

**Task 4.1: å‰åç«¯è”è°ƒ**
- [ ] å‰ç«¯è°ƒç”¨çœŸå®åç«¯ APIï¼ˆä¿®æ”¹ `baseURL` ä¸ºåç«¯åœ°å€ï¼‰
- [ ] æµ‹è¯•å®Œæ•´æµç¨‹ï¼šè¾“å…¥ â†’ æäº¤ â†’ è¿”å›ç»“æœ
- [ ] ä¿®å¤æ¥å£å­—æ®µä¸åŒ¹é…é—®é¢˜
- [ ] æµ‹è¯•ç½‘ç»œé”™è¯¯ã€è¶…æ—¶ç­‰è¾¹ç•Œæƒ…å†µ

**Task 4.2: é«˜é£é™©åœºæ™¯æµ‹è¯•**
- [ ] è¾“å…¥åŒ…å«è‡ªæ€å…³é”®è¯çš„æ–‡æœ¬ï¼ŒéªŒè¯ï¼š
  - RiskClassifier æ­£ç¡®è¯†åˆ«ä¸º CRITICAL
  - ResultScreen æ˜¾ç¤ºçº¢è‰²å®‰å…¨æç¤ºå¡ç‰‡
  - ä¸ç”Ÿæˆå’Œè§£å»ºè®®
- [ ] è¾“å…¥æš´åŠ›å¨èƒæ–‡æœ¬ï¼ŒéªŒè¯ ResponseGuard æ‹¦æˆª
- [ ] è¾“å…¥æ™®é€šæ–‡æœ¬ï¼ŒéªŒè¯æ­£å¸¸æµç¨‹

**Task 4.3: æ—¥å¿—ä¸ç›‘æ§é…ç½®**
- [ ] é…ç½® Python loggingï¼ˆä½¿ç”¨ structlogï¼‰
- [ ] ç¡®ä¿æ•æ„Ÿæ•°æ®ä¸è¢«è®°å½•ï¼ˆå‚è€ƒ 8.5.1ï¼‰
- [ ] è®°å½•å…³é”®æŒ‡æ ‡ï¼ˆriskLevelã€latencyã€guardActionï¼‰
- [ ] ï¼ˆå¯é€‰ï¼‰æ¥å…¥æ—¥å¿—åˆ†æå¹³å°ï¼ˆå¦‚ Sentryï¼‰

**Task 4.4: æ€§èƒ½ä¼˜åŒ–**
- [ ] å‰ç«¯ï¼šä¼˜åŒ– ResultScreen æ¸²æŸ“æ€§èƒ½ï¼ˆä½¿ç”¨ `React.memo`ï¼‰
- [ ] åç«¯ï¼šæ·»åŠ æ•°æ®åº“æŸ¥è¯¢ç´¢å¼•ï¼ˆå¦‚å·²åˆ›å»ºåˆ™éªŒè¯ï¼‰
- [ ] åç«¯ï¼šLLM è¯·æ±‚å¹¶å‘æ§åˆ¶ï¼ˆé¿å…æ»¥ç”¨ï¼‰

**Task 4.5: å®‰å…¨å®¡æŸ¥**
- [ ] Code Reviewï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ˜æ–‡å­˜å‚¨æ•æ„Ÿæ•°æ®
- [ ] æ£€æŸ¥ JWT secret æ˜¯å¦ä½¿ç”¨ç¯å¢ƒå˜é‡
- [ ] æ£€æŸ¥åŠ å¯†å¯†é’¥æ˜¯å¦å®‰å…¨å­˜å‚¨
- [ ] è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿é€šè¿‡ç‡ > 90%

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… å‰åç«¯å®Œæ•´è”è°ƒé€šè¿‡
- âœ… é«˜é£é™©åœºæ™¯æµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… æ—¥å¿—è®°å½•æ­£ç¡®ï¼Œæ— æ•æ„Ÿä¿¡æ¯æ³„éœ²
- âœ… æ€§èƒ½è¾¾æ ‡ï¼ˆåˆ†æè€—æ—¶ < 30 ç§’ï¼‰

---

### 9.6 Phase 5: æµ‹è¯•ä¸æ‰“ç£¨ï¼ˆWeek 4ï¼‰

**ç›®æ ‡**ï¼šä¿®å¤ç»†èŠ‚é—®é¢˜ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œå‡†å¤‡å‘å¸ƒ

#### ä»»åŠ¡æ¸…å•

**Task 5.1: ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
- [ ] ä¼˜åŒ– LoadingScreen åŠ¨ç”»æµç•…åº¦
- [ ] ä¼˜åŒ– AdviceCard çš„æ¶ˆæ¯å¤åˆ¶äº¤äº’ï¼ˆæ˜¾ç¤º"å·²å¤åˆ¶"æç¤ºï¼‰
- [ ] ä¼˜åŒ–è¾“å…¥æ¡†ä½“éªŒï¼ˆå­—æ•°ç»Ÿè®¡ã€å®æ—¶éªŒè¯æç¤ºï¼‰
- [ ] ä¼˜åŒ–é”™è¯¯æç¤ºæ–‡æ¡ˆï¼ˆæ›´å‹å¥½ã€æ›´å…·ä½“ï¼‰

**Task 5.2: è¾¹ç•Œæƒ…å†µæµ‹è¯•**
- [ ] æµ‹è¯•æçŸ­è¾“å…¥ï¼ˆ< 10 å­—ï¼‰
- [ ] æµ‹è¯•æé•¿è¾“å…¥ï¼ˆ> 5000 å­—ï¼‰
- [ ] æµ‹è¯•ç‰¹æ®Šå­—ç¬¦è¾“å…¥ï¼ˆemojiã€æ¢è¡Œç¬¦ï¼‰
- [ ] æµ‹è¯•ç½‘ç»œæ–­å¼€æ—¶çš„è¡Œä¸º
- [ ] æµ‹è¯•åç«¯æœåŠ¡æŒ‚æ‰æ—¶çš„å‰ç«¯é™çº§

**Task 5.3: å¤šè®¾å¤‡é€‚é…**
- [ ] æµ‹è¯• iOS è®¾å¤‡ï¼ˆiPhone ä¸åŒå°ºå¯¸ï¼‰
- [ ] æµ‹è¯• Android è®¾å¤‡ï¼ˆä¸åŒåˆ†è¾¨ç‡ï¼‰
- [ ] æµ‹è¯•æ¨ªå±æ¨¡å¼ï¼ˆå¦‚éœ€æ”¯æŒï¼‰
- [ ] ä¿®å¤å¸ƒå±€é—®é¢˜ï¼ˆSafeAreaViewã€KeyboardAvoidingViewï¼‰

**Task 5.4: å®‰å…¨å›å½’æµ‹è¯•**
- [ ] è¿è¡Œæ‰€æœ‰ RiskClassifier å•å…ƒæµ‹è¯•
- [ ] è¿è¡Œæ‰€æœ‰ ResponseGuard å•å…ƒæµ‹è¯•
- [ ] è¿è¡Œå›æ”¾æµ‹è¯•ï¼ˆ100 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] æ‰‹åŠ¨æµ‹è¯• 10 ä¸ªçœŸå®åœºæ™¯ï¼ˆæ¶µç›–å„é£é™©ç­‰çº§ï¼‰

**Task 5.5: æ–‡æ¡£ä¸éƒ¨ç½²å‡†å¤‡**
- [ ] ç¼–å†™ `README.md`ï¼ŒåŒ…å«ï¼š
  - é¡¹ç›®ä»‹ç»ä¸æŠ€æœ¯æ ˆ
  - å¿«é€Ÿå¼€å§‹ï¼š`npm install` â†’ `npm run install:all` â†’ `npm run dev`
  - ç¯å¢ƒå˜é‡é…ç½®è¯´æ˜ï¼ˆ`.env.example`ï¼‰
  - å¸¸ç”¨å‘½ä»¤åˆ—è¡¨ï¼ˆ`npm run` è„šæœ¬è¯´æ˜ï¼‰
- [ ] ç¼–å†™ `DEPLOYMENT.md`ï¼ˆéƒ¨ç½²æŒ‡å—ï¼šåç«¯ Docker åŒ–ã€å‰ç«¯ Expo å‘å¸ƒï¼‰
- [ ] ç¡®ä¿ `.env.example` å·²åˆ›å»ºï¼ˆå»é™¤çœŸå®å¯†é’¥ï¼‰
- [ ] éªŒè¯ `docker-compose.yml` é…ç½®æ­£ç¡®ï¼ˆå·²åœ¨ Phase 1 åˆ›å»ºï¼‰
- [ ] æ·»åŠ ç”Ÿäº§ç¯å¢ƒ docker-compose é…ç½®ï¼ˆ`docker-compose.prod.yml`ï¼ŒåŒ…å«åç«¯æœåŠ¡ï¼‰

**Task 5.6: MVP å‘å¸ƒ**
- [ ] åç«¯éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ï¼ˆæ¨èï¼šRailwayã€Fly.ioã€AWS ECSï¼‰
- [ ] MongoDB éƒ¨ç½²ï¼ˆæ¨èï¼šMongoDB Atlas å…è´¹å±‚ï¼‰
- [ ] å‰ç«¯é€šè¿‡ Expo å‘å¸ƒåˆ° TestFlight / Google Play Internal Testing
- [ ] é‚€è¯· 5-10 ä½å†…æµ‹ç”¨æˆ·è¯•ç”¨

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… MVP å®Œæ•´åŠŸèƒ½å¯ç”¨ï¼Œæ— é˜»å¡æ€§ Bug
- âœ… å®‰å…¨æµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… éƒ¨ç½²æˆåŠŸï¼Œå¯ä¾›å¤–éƒ¨ç”¨æˆ·è®¿é—®
- âœ… æ–‡æ¡£å®Œæ•´ï¼Œæ–°å¼€å‘è€…å¯ä»¥å¿«é€Ÿä¸Šæ‰‹

---

### 9.7 åç»­è¿­ä»£æ–¹å‘ï¼ˆV2 Feature Ideasï¼‰

**Phase 6+ï¼ˆMVP ä¹‹åï¼‰**ï¼š

**åŠŸèƒ½æ‰©å±•**ï¼š
- [ ] å†å²è®°å½•é¡µï¼ˆHistoryScreenï¼‰
- [ ] åˆ†æè®°å½•çš„äº‘ç«¯åŒæ­¥
- [ ] æ”¯æŒè¯­éŸ³è¾“å…¥ï¼ˆSpeech-to-Textï¼‰
- [ ] æ”¯æŒæˆªå›¾è¯†åˆ«èŠå¤©è®°å½•ï¼ˆOCRï¼‰
- [ ] å¤šè¯­è¨€æ”¯æŒï¼ˆè‹±æ–‡ã€æ—¥æ–‡ï¼‰

**å®‰å…¨å¢å¼º**ï¼š
- [ ] æ¥å…¥ä¸“ä¸šæƒ…æ„Ÿåˆ†ææ¨¡å‹ï¼ˆæ›¿ä»£è§„åˆ™å¼•æ“ï¼‰
- [ ] å¢åŠ äººå·¥å®¡æ ¸æœºåˆ¶ï¼ˆé«˜é£é™©ä¼šè¯ï¼‰
- [ ] æ•°æ®è„±æ•å¢å¼ºï¼ˆå·®åˆ†éšç§ï¼‰

**ä½“éªŒä¼˜åŒ–**ï¼š
- [ ] æ·±è‰²æ¨¡å¼ï¼ˆDark Modeï¼‰
- [ ] ä¸ªæ€§åŒ–ä¸»é¢˜é…ç½®
- [ ] åˆ†æç»“æœåˆ†äº«åŠŸèƒ½ï¼ˆç”Ÿæˆå›¾ç‰‡ï¼‰
- [ ] æ¨é€é€šçŸ¥ï¼ˆåˆ†æå®Œæˆæé†’ï¼‰

**å•†ä¸šåŒ–**ï¼š
- [ ] å…è´¹é¢åº¦ + è®¢é˜…åˆ¶ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰
- [ ] ä»˜è´¹è§£é”å†å²è®°å½•äº‘ç«¯å­˜å‚¨
- [ ] ä¼ä¸šç‰ˆï¼ˆå›¢é˜Ÿåä½œå¤ç›˜ï¼‰

---

## 10. æ€»ç»“ä¸å…³é”®å†³ç­–

### 10.1 æŠ€æœ¯é€‰å‹æ€»ç»“

| æŠ€æœ¯ç‚¹ | é€‰å‹ | ç†ç”± |
|--------|------|------|
| å‰ç«¯æ¡†æ¶ | React Native + Expo | è·¨å¹³å°ã€å¼€å‘æ•ˆç‡é«˜ã€ç”Ÿæ€æˆç†Ÿ |
| å‰ç«¯è¯­è¨€ | TypeScript | ç±»å‹å®‰å…¨ã€é™ä½é”™è¯¯ |
| åç«¯æ¡†æ¶ | FastAPI | é«˜æ€§èƒ½ã€è‡ªåŠ¨æ–‡æ¡£ï¼ˆSwaggerï¼‰ã€å¼‚æ­¥æ”¯æŒ |
| Python åŒ…ç®¡ç† | **uv** | æé€Ÿä¾èµ–å®‰è£…ã€ç°ä»£åŒ–å·¥ä½œæµã€å…¼å®¹ pip ç”Ÿæ€ |
| æ•°æ®åº“ | MongoDB | éç»“æ„åŒ–æ•°æ®å‹å¥½ã€æ˜“æ‰©å±• |
| æ•°æ®åº“éƒ¨ç½² | Docker Compose | æœ¬åœ°å¼€å‘ä¸€é”®å¯åŠ¨ã€ç¯å¢ƒéš”ç¦»ã€æ˜“äºè¿ç§» |
| LLM | OpenAI GPT-4 Turbo | ç†è§£åŠ›å¼ºã€è¾“å‡ºç¨³å®š |
| è®¤è¯ | JWT + é‚®ç®±éªŒè¯ç  | ç®€å•å¯é ã€æ˜“äºå®ç° |
| é¡¹ç›®å‘½ä»¤ç®¡ç† | **npm scripts** | ç»Ÿä¸€å‰åç«¯å‘½ä»¤å…¥å£ã€é™ä½å­¦ä¹ æˆæœ¬ã€ä¾¿äº CI/CD |

### 10.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **å®‰å…¨ç¬¬ä¸€**ï¼šä¸‰å±‚é˜²æŠ¤ï¼ˆè¾“å…¥æ£€æµ‹ â†’ åˆ†çº§ Prompt â†’ è¾“å‡ºå®¡æŸ¥ï¼‰
2. **éšç§ä¿æŠ¤**ï¼šç«¯åˆ°ç«¯åŠ å¯†ã€æ—¥å¿—è„±æ•ã€æ•°æ®å¯åˆ é™¤
3. **é™çº§ä¼˜é›…**ï¼šLLM å¤±è´¥æ—¶è¿”å›å®‰å…¨çš„é™çº§å“åº”ï¼Œè€ŒéæŠ¥é”™
4. **å¯æµ‹è¯•æ€§**ï¼šå…³é”®æ¨¡å—ï¼ˆRiskClassifierã€ResponseGuardï¼‰æœ‰å®Œæ•´å•å…ƒæµ‹è¯•
5. **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½ï¼ˆå¦‚å¤š LLM æ”¯æŒã€å¤šè¯­è¨€ï¼‰

### 10.3 é£é™©ä¸åº”å¯¹

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|---------|
| LLM è¾“å‡ºä¸å¯æ§ | å¯èƒ½ç”Ÿæˆä¸å®‰å…¨å»ºè®® | ResponseGuard å¤šé‡å®¡æŸ¥ + å›æ”¾æµ‹è¯• |
| LLM æˆæœ¬è¿‡é«˜ | è¿è¥æˆæœ¬ä¸å¯æŒç»­ | åˆæœŸé™åˆ¶å…è´¹é¢åº¦ã€æœªæ¥å¼•å…¥ GPT-3.5 é™çº§ |
| ç”¨æˆ·æ»¥ç”¨ | æ¶æ„è¾“å…¥ã€é¢‘ç¹è¯·æ±‚ | Rate Limit + å•ç”¨æˆ·æ¯æ—¥é…é¢ |
| éšç§æ³„éœ² | ç›‘ç®¡é£é™©ã€ç”¨æˆ·ä¿¡ä»»å±æœº | åŠ å¯†å­˜å‚¨ + æ—¥å¿—è„±æ• + æ•°æ®å¯åˆ é™¤ |

### 10.4 æˆåŠŸæŒ‡æ ‡ï¼ˆMVP é˜¶æ®µï¼‰

**æŠ€æœ¯æŒ‡æ ‡**ï¼š
- åˆ†ææˆåŠŸç‡ > 95%
- å¹³å‡å“åº”æ—¶é—´ < 30 ç§’
- å®‰å…¨æµ‹è¯•é€šè¿‡ç‡ = 100%

**äº§å“æŒ‡æ ‡**ï¼š
- å†…æµ‹ç”¨æˆ·ç•™å­˜ç‡ > 60%ï¼ˆ7 å¤©ï¼‰
- ç”¨æˆ·åé¦ˆ"æœ‰å¸®åŠ©"æ¯”ä¾‹ > 70%
- æ— é‡å¤§å®‰å…¨äº‹æ•…

---

**æ–‡æ¡£ç¼–å†™å®Œæˆæ—¥æœŸ**: 2025-11-26  
**ä¸‹ä¸€æ­¥**: ç­‰å¾…ç¡®è®¤åï¼Œè¿›å…¥ Phase 1 å¼€å‘é˜¶æ®µ

